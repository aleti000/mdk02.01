**Лабораторная работа №13 по теме: Настройка протокола SSH в ALT Linux**

---

### **Цель работы**  
Освоить комплексную настройку протокола SSH в операционной системе ALT Linux. Научиться безопасно управлять удалёнными виртуальными машинами в сегментированной сети, включая использование ключевой аутентификации, ограничение доступа, настройку клиентской конфигурации и подключение к изолированной системе через промежуточный хост (`ProxyJump`). Получить практические навыки администрирования SSH-сервера и повышения уровня безопасности.

---

### **Задачи работы**
1. Установить и запустить SSH-сервер на двух виртуальных машинах под ALT Linux.
2. Создать специального пользователя для SSH-доступа.
3. Изучить и настроить основные параметры конфигурации SSH-сервера (`/etc/ssh/sshd_config`).
4. Ограничить доступ к SSH по пользователям и группам.
5. Настроить клиентский файл `~/.ssh/config` с использованием `ProxyJump` для доступа к изолированной машине.
6. Выполнить подключение по паролю.
7. Сгенерировать SSH-ключи и скопировать их на обе машины.
8. Обеспечить подключение без ввода пароля.
9. Отключить аутентификацию по паролю после настройки ключей.
10. Продемонстрировать работу сегментированной сети с использованием бастион-хоста.

---

### **Методические указания**

#### **Теоретическая часть**

**SSH (Secure Shell)** — защищённый протокол для удалённого доступа к системам через незащищённые сети. Он обеспечивает шифрование соединения, аутентификацию и возможность выполнения команд, передачи файлов и проброса туннелей.

**Сценарий сети:**
- **VM1 (бастион-хост):**
  - Интерфейс 1: Bridge → физическая сеть (`192.168.1.100`)
  - Интерфейс 2: Внутренняя виртуальная сеть (`10.0.0.10`) → соединён с VM2
- **VM2 (изолированная машина):**
  - Подключена только к внутренней сети (`10.0.0.20`)
  - **Нет прямого доступа извне**
  - Доступ возможен **только через VM1**

Этот сценарий имитирует реальную инфраструктуру, где часть серверов находится в защищённой зоне (например, DMZ или внутренняя сеть), а доступ к ним осуществляется через **бастион-хост**.

---

### **Практическая часть**

---

#### **Шаг 1: Установка SSH-сервера (на VM1 и VM2)**

На каждой виртуальной машине выполните:

```bash
sudo apt-get update
sudo apt-get install openssh-server
sudo systemctl enable sshd
sudo systemctl start sshd
```

> ALT Linux использует `apt-get` (через `apt-rpm`) и называет службу `sshd`.

Проверьте статус:

```bash
sudo systemctl status sshd
```

---

#### **Шаг 2: Создание пользователя для SSH-доступа**

На **обеих машинах (VM1 и VM2)** создайте пользователя `sshuser`:

```bash
sudo useradd -m -s /bin/bash sshuser
sudo passwd sshuser
```

> Установите надёжный пароль.

Добавьте пользователя в группу `wheel` (для прав `sudo`):

```bash
sudo usermod -aG wheel sshuser
```

---

#### **Шаг 3: Настройка файла `/etc/ssh/sshd_config`**

Откройте конфигурационный файл:

```bash
sudo nano /etc/ssh/sshd_config
```

---

##### **Описание ключевых параметров `/etc/ssh/sshd_config`**

| Параметр | Описание | Рекомендуемое значение |
|--------|---------|------------------------|
| `Port` | Порт SSH-сервера. Можно изменить для усложнения атак. | `Port 22` |
| `ListenAddress` | Указывает, на каком IP слушать. Полезно для ограничения. | `ListenAddress 0.0.0.0` |
| `PermitRootLogin` | Разрешает ли вход под root. **Опасно!** | `no` |
| `PasswordAuthentication` | Разрешает вход по паролю. | `yes` (сначала), затем `no` |
| `PubkeyAuthentication` | Включает аутентификацию по ключу. | `yes` |
| `AuthorizedKeysFile` | Путь к файлу с доверенными ключами. | `.ssh/authorized_keys` |
| `PermitEmptyPasswords` | Разрешает пустые пароли. | `no` |
| `ChallengeResponseAuthentication` | Используется для 2FA. | `no` |
| `UsePAM` | Использование PAM-модулей. | `yes` |
| `X11Forwarding` | Передача графического интерфейса. | `yes` (по желанию) |
| `AllowUsers` | Разрешить только указанных пользователей. | `AllowUsers sshuser` |
| `DenyUsers` | Запретить указанных пользователей. | `DenyUsers root` |
| `AllowGroups` | Разрешить доступ группе. | `AllowGroups wheel` |
| `MaxAuthTries` | Максимум попыток входа. | `3` |
| `LoginGraceTime` | Время на аутентификацию (сек). | `60` |
| `ClientAliveInterval` | Интервал "живых" проверок. | `300` |
| `ClientAliveCountMax` | Сколько раз проверить, прежде чем разорвать. | `3` |

---

##### **Пример конфигурации `/etc/ssh/sshd_config`**

```conf
Port 22
PermitRootLogin no
PasswordAuthentication yes
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes
X11Forwarding yes
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/ssh/sftp-server

# Контроль доступа
AllowUsers sshuser
DenyUsers root

# Ограничения безопасности
MaxAuthTries 3
LoginGraceTime 60

# Поддержка активности
ClientAliveInterval 300
ClientAliveCountMax 3
```

> После редактирования **обязательно перезапустите SSH**:

```bash
sudo systemctl restart sshd
```

---

#### **Шаг 4: Подключение по паролю**

С основного компьютера:

```bash
ssh sshuser@192.168.1.100
```

С VM1 подключитесь к VM2:

```bash
ssh sshuser@10.0.0.20
```

> Убедитесь, что на VM2 SSH-сервер запущен и настроен аналогично.

---

#### **Шаг 5: Генерация SSH-ключа (на основном компьютере)**

```bash
ssh-keygen -t rsa -b 4096 -C "sshuser@lab" -f ~/.ssh/id_lab
```

> Сохраните ключ в `~/.ssh/id_lab`.

---

#### **Шаг 6: Копирование ключа на VM1 и VM2**

На основном компьютере:

```bash
ssh-copy-id -i ~/.ssh/id_lab.pub sshuser@192.168.1.100
```

На VM1 (после входа):

```bash
ssh-copy-id -i ~/.ssh/id_lab.pub sshuser@10.0.0.20
```

> Если `ssh-copy-id` недоступен — скопируйте ключ вручную:

```bash
cat ~/.ssh/id_lab.pub | ssh sshuser@192.168.1.100 "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

---

#### **Шаг 7: Настройка `~/.ssh/config` (на основном компьютере)**

```bash
nano ~/.ssh/config
```

```conf
Host vm1
    HostName 192.168.1.100
    User sshuser
    Port 22
    IdentityFile ~/.ssh/id_lab

Host vm2
    HostName 10.0.0.20
    User sshuser
    Port 22
    IdentityFile ~/.ssh/id_lab
    ProxyJump vm1
```

> `ProxyJump vm1` — туннелирование через бастион-хост.

---

#### **Шаг 8: Подключение без пароля**

Теперь можно подключаться:

```bash
ssh vm1        # Прямое подключение
ssh vm2        # Через VM1, без пароля
```

---

#### **Шаг 9: Отключение аутентификации по паролю**

На **VM1 и VM2** отредактируйте `/etc/ssh/sshd_config`:

```conf
PasswordAuthentication no
```

Перезапустите SSH:

```bash
sudo systemctl restart sshd
```

> Теперь доступ **только по ключу**. Убедитесь, что вы не потеряете доступ!

---

#### **Шаг 10: Проверка сценария**

С основного компьютера:

```bash
ssh vm2
```

Если всё работает:
- Подключение к `vm2` проходит через `vm1`.
- Используются SSH-ключи.
- Пароль не запрашивается.
- Изолированная машина недоступна напрямую.

---

### **Задание повышенной сложности**

**Цель:** Реализовать многоуровневую архитектуру с дополнительными мерами безопасности.

**Условия:**
1. Измените порт SSH на **VM2** с `22` на `2222`.
2. Настройте `ProxyJump` так, чтобы он учитывал нестандартный порт.
3. На **VM1** создайте **локальный SSH-туннель**, пробрасывающий порт `8080` на основной компьютер, который будет указывать на веб-сервер, запущенный на VM2 (например, простой `python3 -m http.server 80`).
4. На **VM2** настройте `iptables` так, чтобы SSH-доступ разрешался **только с IP-адреса VM1**.
5. На **основном компьютере** настройте `~/.ssh/config` для автоматического проброса порта при подключении к `vm2`.

**Решение (подсказки):**

- Изменение порта на VM2:
  ```conf
  # /etc/ssh/sshd_config на VM2
  Port 2222
  ```
  Перезапустите: `sudo systemctl restart sshd`

- Обновление `~/.ssh/config`:
  ```conf
  Host vm2
      HostName 10.0.0.20
      User sshuser
      Port 2222
      IdentityFile ~/.ssh/id_lab
      ProxyJump vm1
      LocalForward 8080 10.0.0.20:80
  ```

- Запуск веб-сервера на VM2:
  ```bash
  python3 -m http.server 80
  ```

- Ограничение доступа через `iptables` на VM2:
  ```bash
  sudo iptables -A INPUT -p tcp --dport 2222 -s 10.0.0.10 -j ACCEPT
  sudo iptables -A INPUT -p tcp --dport 2222 -j DROP
  ```

- Проверка:
  ```bash
  ssh vm2
  ```
  Затем откройте в браузере `http://localhost:8080` — должен открыться каталог с VM2.

---

### **Контрольные вопросы**
1. Зачем используется `ProxyJump`? Чем он отличается от `ProxyCommand`?
2. Почему важно отключать `PermitRootLogin`?
3. Как работает механизм `authorized_keys`?
4. Что такое бастион-хост и зачем он нужен?
5. Как `iptables` помогает в защите SSH?

---

### **Вывод**

В ходе лабораторной работы были выполнены:
- Установка и настройка SSH-сервера на двух виртуальных машинах под ALT Linux.
- Создан и настроен пользователь `sshuser`.
- Изучены и применены ключевые параметры `/etc/ssh/sshd_config`.
- Реализовано управление доступом по пользователям.
- Настроен клиентский доступ через `ProxyJump`.
- Выполнена настройка аутентификации по ключам.
- Обеспечено безопасное подключение к изолированной системе.
- Выполнено задание повышенной сложности с изменением порта, туннелированием и фильтрацией трафика.

Работа демонстрирует современные практики безопасного удалённого администрирования в сегментированных сетях.

---

**Примечания:**
- Все действия совместимы с ALT Linux.
- При изменении порта или отключении паролей используйте резервный доступ (консоль гипервизора).
- Регулярно проверяйте логи SSH: `sudo tail -f /var/log/secure`.
