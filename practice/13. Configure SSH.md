**Лабораторная работа №13 по теме: Настройка протокола SSH в ALT Linux**

---

### **Цель работы**  
Освоить настройку и безопасное использование протокола SSH в операционной системе ALT Linux, включая настройку SSH-сервера, управление доступом, использование ключевой аутентификации и подключение к изолированной виртуальной машине через промежуточный хост с использованием `ProxyJump`.

---

### **Задачи работы**
1. Настроить SSH-сервер на виртуальных машинах (VM1 и VM2) под управлением ALT Linux.
2. Настроить базовые параметры SSH-сервера (`/etc/ssh/sshd_config`), включая управление доступом по пользователям и группам.
3. Настроить SSH-клиент (`~/.ssh/config`) с использованием параметра `ProxyJump` для доступа к изолированной машине (VM2) через промежуточную (VM1).
4. Осуществить подключение к виртуальным машинам с использованием пароля.
5. Настроить аутентификацию по SSH-ключам.
6. Выполнить копирование открытого ключа на обе машины.
7. Обеспечить подключение без ввода пароля.
8. Продемонстрировать изменение параметров безопасности в конфигурационных файлах при изменении требований к доступу.

---

### **Методические указания**

#### **Теоретическая часть**

**SSH (Secure Shell)** — криптографический сетевой протокол для безопасного удалённого доступа к компьютерам через незащищённые сети. Он позволяет выполнять команды на удалённой машине, передавать файлы и организовывать зашифрованные туннели.

**Основные компоненты:**
- `sshd` — демон SSH-сервера, слушает порт 22 (по умолчанию).
- `ssh` — клиентская утилита для подключения.
- `ssh-keygen` — генерация ключей.
- `ssh-copy-id` — копирование публичного ключа на удалённый хост.
- `~/.ssh/config` — пользовательский конфигурационный файл клиента.
- `ProxyJump` — возможность подключения к хосту через промежуточный («бастион»).

**Сценарий:**
- **VM1**: имеет два сетевых интерфейса:
  - Bridge — доступ в физическую сеть (например, `192.168.1.100`).
  - Внутренняя виртуальная сеть (например, `10.0.0.10`) — соединена с VM2.
- **VM2**: подключена только к внутренней виртуальной сети (`10.0.0.20`), **не имеет прямого доступа извне**.
- Доступ к VM2 возможен **только через VM1**.

---

### **Практическая часть**

#### **Шаг 1: Установка и запуск SSH-сервера (на обеих машинах)**

На каждой виртуальной машине выполните:

```bash
sudo apt-get update
sudo apt-get install openssh-server
sudo systemctl enable sshd
sudo systemctl start sshd
```

> В ALT Linux пакетный менеджер — `apt-get`, а служба SSH называется `sshd`.

---

#### **Шаг 2: Настройка SSH-сервера (на VM1 и VM2)**

Откройте конфигурационный файл SSH-сервера:

```bash
sudo nano /etc/ssh/sshd_config
```

**Базовые параметры для настройки:**

```conf
Port 22
PermitRootLogin no
PasswordAuthentication yes
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes
X11Forwarding yes
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/ssh/sftp-server
```

**Управление доступом пользователей/групп:**

Добавьте в конец файла:

```conf
# Разрешить только пользователя user1 и группу admins
AllowUsers user1
# AllowGroups admins

# Запретить определённых пользователей
DenyUsers root, guest
```

> Убедитесь, что пользователь `user1` существует:  
> ```bash
> sudo useradd -m -s /bin/bash user1
> sudo passwd user1
> ```

Перезапустите SSH-сервер:

```bash
sudo systemctl restart sshd
```

---

#### **Шаг 3: Подключение по паролю**

С основного компьютера подключитесь к VM1:

```bash
ssh user1@192.168.1.100
```

С VM1 подключитесь к VM2:

```bash
ssh user1@10.0.0.20
```

> Убедитесь, что на VM2 также настроен SSH-сервер и пользователь `user1`.

---

#### **Шаг 4: Генерация SSH-ключа на локальной машине**

На **основном компьютере (не на VM)**:

```bash
ssh-keygen -t rsa -b 4096 -C "user@lab"
# Сохраните ключ в ~/.ssh/id_rsa_lab
```

---

#### **Шаг 5: Копирование ключа на VM1 и VM2**

Копирование на VM1:

```bash
ssh-copy-id -i ~/.ssh/id_rsa_lab.pub user1@192.168.1.100
```

Для копирования на VM2 нужно сначала зайти на VM1, затем:

```bash
ssh user1@192.168.1.100
ssh-copy-id -i ~/.ssh/id_rsa_lab.pub user1@10.0.0.20
```

> Если `ssh-copy-id` недоступен, можно скопировать ключ вручную:

```bash
cat ~/.ssh/id_rsa_lab.pub | ssh user1@192.168.1.100 "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

Аналогично — на VM2 через VM1.

---

#### **Шаг 6: Настройка файла `~/.ssh/config` (на основном компьютере)**

Создайте или отредактируйте:

```bash
nano ~/.ssh/config
```

Добавьте следующие секции:

```conf
# VM1 — прямое подключение
Host vm1
    HostName 192.168.1.100
    User user1
    Port 22
    IdentityFile ~/.ssh/id_rsa_lab

# VM2 — доступ через VM1 (ProxyJump)
Host vm2
    HostName 10.0.0.20
    User user1
    Port 22
    IdentityFile ~/.ssh/id_rsa_lab
    ProxyJump vm1
```

> `ProxyJump` указывает, что для доступа к `vm2` нужно сначала подключиться к `vm1`.

---

#### **Шаг 7: Подключение без пароля**

Теперь можно подключаться:

```bash
# К VM1
ssh vm1

# К VM2 через VM1
ssh vm2
```

> Подключение должно происходить **без запроса пароля**, так как используется SSH-ключ.

---

#### **Шаг 8: Дополнительная настройка безопасности**

**Запрет аутентификации по паролю (только по ключам)**

На **VM1 и VM2** отредактируйте `/etc/ssh/sshd_config`:

```conf
PasswordAuthentication no
```

Перезапустите SSH:

```bash
sudo systemctl restart sshd
```

Теперь подключение по паролю невозможно — только по ключу.

> Убедитесь, что ключ уже скопирован, иначе потеряете доступ!

---

#### **Шаг 9: Проверка доступа к изолированной машине**

С основного компьютера:

```bash
ssh vm2
```

Если всё настроено верно:
- SSH использует `~/.ssh/config`.
- Подключается к `vm1` с помощью ключа.
- Через `ProxyJump` перенаправляется на `vm2`.
- Подключается к `vm2` с помощью ключа.
- Всё — без ввода паролей.

---

### **Контрольные вопросы**
1. Для чего используется параметр `ProxyJump` в SSH?
2. Какие преимущества у аутентификации по ключам перед паролем?
3. Какие параметры в `/etc/ssh/sshd_config` влияют на безопасность SSH-сервера?
4. Почему изолированная машина (VM2) не может быть доступна напрямую?
5. Как работает туннелирование SSH через промежуточный хост?

---

### **Вывод**

В ходе лабораторной работы были выполнены:
- Установка и настройка SSH-сервера на двух виртуальных машинах под ALT Linux.
- Ограничение доступа по пользователям и группам.
- Настройка безопасного подключения через `ProxyJump`.
- Переход с парольной аутентификации на ключевую.
- Обеспечение бесшовного доступа к изолированной машине.

Работа демонстрирует применение SSH в реальных сценариях сегментированных сетей и повышения уровня безопасности удалённого доступа.

---

**Примечание:**  
- Все команды выполняются с учётом особенностей ALT Linux (основан на RPM, но использует `apt` через `apt-rpm`).
- Убедитесь, что в настройках виртуализации (VirtualBox, VMware, KVM) сетевые интерфейсы сконфигурированы корректно.
- Резервируйте доступ (например, консоль ВМ) перед отключением `PasswordAuthentication`.
