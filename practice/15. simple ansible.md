**Лабораторная работа №__ по теме: Введение в Ansible на ALT Linux**

---

### **Цель работы**  
Освоить основы работы с инструментом автоматизации **Ansible** в операционной системе **ALT Linux**. Научиться настраивать инвентаризацию, конфигурацию Ansible, выполнять ad-hoc команды и управлять группами хостов в сегментированной сети, где одна машина (VM1) выступает как **контроллер**, а вторая (VM2) — как **управляемый узел**, доступный только через VM1.

---

### **Задачи работы**
1. Проверить и настроить сетевую конфигурацию обеих виртуальных машин.
2. Убедиться в корректной работе SSH и настройке `iptables` для обеспечения доступа.
3. Установить Ansible на VM1 (контроллер).
4. Создать файл инвентаризации `inventory.ini`.
5. Настроить конфигурационный файл `ansible.cfg`.
6. Выполнить ad-hoc команды с использованием базовых модулей Ansible (`ping`, `command`, `shell`, `copy`, `user`).
7. Изучить структуру команды `ansible` и принцип её построения.

---

### **Методические указания**

#### **Теоретическая часть**

**Ansible** — это инструмент ИТ-автоматизации с открытым исходным кодом, позволяющий:
- Управлять конфигурацией систем,
- Развертывать приложения,
- Выполнять задачи администрирования.

Особенности Ansible:
- Работает по протоколу **SSH** (не требует установки агентов на удалённых хостах),
- Использует **инвентаризацию** для описания целевых хостов,
- Поддерживает **ad-hoc команды** и **playbook’и**,
- Конфигурируется через файл `ansible.cfg`.

**Сценарий сети:**
- **VM1 (Контроллер):**
  - Bridge → физическая сеть (`DHCP`)
  - Внутренняя сеть → `10.0.0.10`
  - На ней установлен **Ansible**
- **VM2 (Управляемый узел):**
  - Только внутренняя сеть → `10.0.0.20`
  - Доступна **только через VM1**
  - Управление осуществляется через **SSH-туннелирование**

> Для успешной работы Ansible необходимо:
> - Наличие SSH-доступа к управляемым хостам,
> - Аутентификация по ключам,
> - Открытые порты и разрешающие правила в `iptables`,
> - Наличие Python на управляемых хостах.

---

### **Практическая часть**

---

#### **Шаг 1: Проверка и настройка сети и SSH (на обеих VM)**

##### **1.1. Проверка IP-адресов**

На **VM1**:
```bash
ip a
# Ожидаемые интерфейсы:
# enp0s3 (или eth0) → DHCP (Bridge)
# enp0s8 (или другой) → 10.0.0.10 (Внутренняя сеть)
```

На **VM2**:
```bash
ip a
# Должен быть интерфейс с IP: 10.0.0.20
```

##### **1.2. Настройка SSH (повторение из предыдущей лабораторной)**

Убедитесь, что:
- SSH-сервер установлен и запущен:
  ```bash
   apt-get install openssh-server
   systemctl enable sshd &&  systemctl start sshd
  ```
- Пользователь создан (например, `ansible_user`):
  ```bash
   useradd -m -s /bin/bash ansible_user
   passwd ansible_user
   usermod -aG wheel ansible_user
  ```

- Аутентификация по ключу настроена:
  - Сгенерируйте ключ на VM1: `ssh-keygen`
  - Скопируйте на VM2: `ssh-copy-id ansible_user@10.0.0.20`

- Проверьте подключение:
  ```bash
  ssh ansible_user@10.0.0.20
  ```

##### **1.3. Настройка `iptables` (на VM2)**

Разрешите SSH-доступ **только от VM1**:

```bash
 iptables -A INPUT -p tcp --dport 22 -s 10.0.0.10 -j ACCEPT
 iptables -A INPUT -p tcp --dport 22 -j DROP
```

Сохраните правила (если пакет `iptables-services` установлен):
```bash
iptables-save -f /etc/sysconfig/iptables
```
В файле /etc/net/sysctl.conf в строке net.ipv4.ip_forward = 0
Замените 0 на 1 и выполните команду
```bash
sysctl -p
```


> Это гарантирует, что внешние хосты не смогут подключиться к VM2 напрямую.

---

#### **Шаг 2: Установка Ansible на VM1**

На **VM1** выполните:

```bash
 apt-get update
 apt-get install ansible
```

Проверьте установку:
```bash
ansible --version
```

> Убедитесь, что версия Ansible отображается корректно.

---

#### **Шаг 3: Создание файла инвентаризации `inventory.ini`**

Создайте каталог проекта и файл инвентаризации:

```bash
mkdir ~/ansible-project && cd ~/ansible-project
nano inventory.ini
```

Пример содержимого:

```ini
[vm2]
10.0.0.20 ansible_user=ansible_user

[all:vars]
ansible_ssh_common_args='-o ProxyCommand="ssh -W %h:%p ansible_user@10.0.0.10"'
```

> **Объяснение:**
> - `[vm2]` — группа хостов (можно добавить больше).
> - `10.0.0.20` — IP VM2.
> - `ansible_user=ansible_user` — пользователь для подключения.
> - `ansible_ssh_common_args` — параметр, который указывает Ansible подключаться к VM2 **через VM1** с помощью SSH-туннеля (`ProxyCommand`).

---

#### **Шаг 4: Настройка `ansible.cfg`**

Создайте конфигурационный файл:

```bash
nano ansible.cfg
```

Содержимое:

```ini
[defaults]
inventory = ./inventory.ini
host_key_checking = False
deprecation_warnings = False
retry_files_enabled = False

[ssh_connection]
scp_if_ssh = True
```

> **Объяснение параметров:**
> - `inventory` — путь к файлу инвентаризации (по умолчанию).
> - `host_key_checking = False` — отключает запрос на подтверждение нового хоста (удобно для автоматизации).
> - `deprecation_warnings = False` — скрывает предупреждения.
> - `scp_if_ssh = True` — использует SCP вместо SFTP (лучшая совместимость).

---

#### **Шаг 5: Ad-hoc режим Ansible**

Ad-hoc команды — одноразовые команды, выполняемые немедленно через `ansible`.

##### **Структура команды:**

```bash
ansible <хост_или_группа> -m <модуль> -a "<аргументы>" [опции]
```

| Часть | Описание |
|------|---------|
| `<хост_или_группа>` | Например, `vm2` или `all` |
| `-m` | Указывает модуль |
| `-a` | Аргументы для модуля |
| Опции | Дополнительные флаги: `-i`, `--become`, `-v` и др. |

---

##### **Примеры ad-hoc команд**

**1. Проверка связи (модуль `ping`)**

```bash
ansible vm2 -m ping
```

> Ожидаемый ответ: `SUCCESS => "ping": "pong"`

**2. Выполнение команды (модуль `command`)**

```bash
ansible vm2 -m command -a "whoami"
```

> Вернёт: `ansible_user`

**3. Запуск shell-команды (модуль `shell`)**

```bash
ansible vm2 -m shell -a "echo 'Hello from VM2' > /home/ansible_user/hello.txt"
```

> Создаст файл на VM2.

**4. Копирование файла (модуль `copy`)**

```bash
echo "Test content" > ~/test.txt
ansible vm2 -m copy -a "src=~/test.txt dest=/home/ansible_user/test.txt owner=ansible_user mode=0644"
```

**5. Управление пользователями (модуль `user`)**

```bash
ansible vm2 -m user -a "name=testuser state=present"
```

> Создаст пользователя `testuser` на VM2.

**6. Повышение привилегий (с `--become`)**

```bash
ansible vm2 -m user -a "name=admin state=present" --become --ask-become-pass
```

> Запросит пароль `` (пароль пользователя `ansible_user`).

---

#### **Шаг 6: Проверка доступа ко всем хостам**

```bash
ansible all -m ping
```

Если всё настроено верно — все хосты ответят `pong`.

---

### **Задание повышенной сложности (по желанию)**

1. Добавьте в `inventory.ini` несколько хостов (например, имитация через алиасы).
2. Создайте группу `[servers]` и выполните команду для всей группы.
3. Настройте `ansible-vault` для шифрования паролей.
4. Напишите простой playbook, который:
   - Обновляет пакеты,
   - Создаёт пользователя,
   - Копирует файл.

---

### **Контрольные вопросы**
1. Как работает `ProxyCommand` в SSH и зачем он нужен в Ansible?
2. Чем отличаются модули `command` и `shell`?
3. Зачем нужен файл `ansible.cfg`?
4. Почему Ansible не требует агентов на удалённых хостах?
5. Как Ansible использует SSH для управления хостами?

---

### **Вывод**

В ходе лабораторной работы:
- Была проверена и настроена сетевая топология двух виртуальных машин.
- Обеспечена безопасность через `iptables` и SSH-ключи.
- Установлен и настроен Ansible на VM1.
- Созданы файлы `inventory.ini` и `ansible.cfg`.
- Выполнены ad-hoc команды с использованием ключевых модулей.
- Продемонстрирована возможность управления изолированным хостом через бастион-хост.

Работа показывает эффективность Ansible для автоматизации задач в сегментированных сетях без необходимости в сложной инфраструктуре.

---

**Примечания:**
- Все действия выполняются в **ALT Linux**.
- Убедитесь, что Python установлен на VM2: `python3 --version`.
- При ошибках проверяйте SSH-подключение вручную.
- Используйте флаг `-v` для подробного вывода: `ansible vm2 -m ping -v`.
