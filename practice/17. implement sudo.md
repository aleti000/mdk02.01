**Лабораторная работа №17 по теме: Разделение прав доступа на основе `sudo` в ALT Linux**

---

### **Цель работы**  
Освоить принципы управления привилегированными правами в операционной системе ALT Linux с использованием утилиты `sudo`. Научиться настраивать файл `/etc/sudoers`, создавать алиасы, выдавать права пользователям и группам, а также автоматизировать настройку с помощью Ansible.

---

### **Задачи работы**
1. Изучить назначение и принцип работы `sudo`.
2. Установить и настроить `sudo` от имени пользователя `root`.
3. Изучить структуру и синтаксис файла `/etc/sudoers`.
4. Создать и использовать алиасы (User_Alias, Host_Alias, Cmnd_Alias).
5. Выдать ограниченные права пользователям и группам.
6. Проверить работу `sudo` через тестовые команды.
7. Автоматизировать настройку `sudo` с помощью Ansible.

---

### **Методические указания**

#### **1. Что такое `sudo`?**

**Назначение:**  
`sudo` (superuser do) — утилита, позволяющая обычному пользователю выполнять команды с правами другого пользователя (обычно `root`), при этом контролируя и логируя действия.

**Принцип работы:**
- Пользователь вводит свою **собственную** пару логин/пароль.
- Система проверяет, разрешено ли ему выполнение данной команды (на основе `/etc/sudoers`).
- Если разрешено — команда выполняется с повышенными привилегиями.
- Все действия записываются в лог (обычно `/var/log/secure` или `/var/log/auth.log`).

**Установка `sudo` (от имени root):**

На ALT Linux `sudo` может быть не установлен по умолчанию. Установите его:

```bash
su -  # переключиться на root
apt-get update
apt-get install sudo
```

> Убедитесь, что пакет `sudo` доступен в репозитории.

После установки добавьте пользователя в группу `wheel` (группа по умолчанию для `sudo`):

```bash
usermod -aG wheel sshuser
```

---

#### **2. Файл `/etc/sudoers`**

Это **главный конфигурационный файл**, определяющий, кто, где, какие команды может выполнять.

**Важно!**  
Файл **нельзя редактировать напрямую** через `nano` или `vi`. Используйте только команду:

```bash
visudo
```

Она проверяет синтаксис перед сохранением и предотвращает ошибки, которые могут заблокировать доступ.

---

##### **Синтаксис строк в `/etc/sudoers`:**

```
Пользователь    Хост = (Кто_именно)   Команды
```

Пример:
```conf
sshuser ALL=(ALL) ALL
```
- `sshuser` — пользователь
- `ALL` — на всех хостах
- `(ALL)` — от имени любого пользователя
- `ALL` — любые команды

---

##### **Алиасы (Aliases)**

Алиасы позволяют группировать пользователей, хосты или команды для удобства и масштабируемости.

**Типы алиасов:**

| Тип | Назначение | Пример |
|-----|-----------|--------|
| `User_Alias` | Группировка пользователей | `ADMINS = user1, user2` |
| `Host_Alias` | Группировка хостов | `SERVERS = 192.168.1.10, 192.168.1.11` |
| `Cmnd_Alias` | Группировка команд | `SERVICES = /sbin/service, /sbin/reboot` |

---

##### **Пример настройки `/etc/sudoers` с алиасами**

Откройте редактор:

```bash
visudo
```

Добавьте следующие строки:

```conf
# Алиасы
User_Alias    OPERATORS = user1, user2
User_Alias    ADMINS    = sshuser, admin

Host_Alias    INTERNAL  = 10.0.0.10, 10.0.0.20
Host_Alias    DMZ       = 192.168.1.100

Cmnd_Alias    SERVICES  = /sbin/service, /sbin/reboot, /sbin/shutdown
Cmnd_Alias    PKGMGMT   = /usr/bin/apt-get, /usr/sbin/update-alternatives

# Правила
ADMINS    ALL = (ALL) ALL
OPERATORS INTERNAL = (root) SERVICES
%wheel    ALL = (ALL) ALL

# Ограничение: пользователь user3 может только обновлять пакеты
user3     ALL = (root) PKGMGMT
```

> `%wheel` — означает **всех пользователей группы `wheel`**

---
### Настройка control для работы sudo
В ALT Linux sudo используется фреймворк control, который задаёт права на выполнение команды sudo.

С его помощью можно дать или отнять права на использование команды sudo.

Возможные значения control sudo можно посмотреть командой control sudo help:

```
$ su -
# control sudo help
На текущий момент существуют следующие политики у команды sudo:
```

**public** — любой пользователь может получить доступ к команде /usr/bin/sudo
**wheelonly** — только пользователи из группы wheel имеют право получить доступ к команде /usr/bin/sudo
**restricted** — только root имеет право выполнять команду /usr/bin/sudo

#### **3. Практическое задание для студента**

**Задача:**  
Настроить систему так, чтобы:
1. Пользователь `operator` мог только перезагружать систему и управлять службами (`systemctl restart`, `reboot`).
2. Пользователь `deployer` мог запускать только скрипты из `/opt/deploy/`.
3. Группа `admins` имела полный доступ через `sudo`.

**Выполнение:**

1. Создайте пользователей:

```bash
sudo useradd -m -s /bin/bash operator
sudo passwd operator

sudo useradd -m -s /bin/bash deployer
sudo passwd deployer
```

2. Создайте директорию и тестовый скрипт:

```bash
sudo mkdir /opt/deploy
sudo bash -c 'echo "#!/bin/bash\necho \"Deploy script running...\"" > /opt/deploy/deploy.sh'
sudo chmod +x /opt/deploy/deploy.sh
```

3. Отредактируйте `/etc/sudoers`:

```bash
visudo
```

Добавьте:

```conf
Cmnd_Alias    SYSCTL    = /sbin/reboot, /bin/systemctl restart *, /bin/systemctl stop *, /bin/systemctl start *
Cmnd_Alias    DEPLOY    = /opt/deploy/*.sh

operator      ALL = (root) SYSCTL
deployer      ALL = (root) DEPLOY
%admins       ALL = (ALL) ALL
```

4. Добавьте пользователей в группы:

```bash
sudo groupadd admins
sudo usermod -aG admins sshuser
```

5. Проверка:

```bash
# От имени operator
sudo reboot                    # должно работать
sudo ls /root                  # должно быть запрещено

# От имени deployer
sudo /opt/deploy/deploy.sh     # работает
sudo vim /opt/deploy/test.sh   # запрещено (не в списке)
```

---

#### **4. Настройка `sudo` с помощью Ansible**

Ansible позволяет централизованно управлять конфигурацией `sudo` на множестве машин.

**Пример playbook: `setup_sudo.yml`**

```yaml
---
- name: Настройка sudo на серверах
  hosts: all
  become: yes
  vars:
    community.general.sudoers:
      - name: operator
        commands: "/sbin/reboot, /bin/systemctl"
      - name: deployer
        commands: "/opt/deploy/*.sh"

  tasks:
    - name: Установка sudo
      apt_rpm:
        name: sudo
        state: present

    - name: Создание пользователей
      user:
        name: "{{ item.name }}"
        shell: /bin/bash
        create_home: yes
        password: "{{ 'password' | password_hash('sha512') }}"
      loop: "{{ sudo_users }}"

    - name: Создание директории /opt/deploy
      file:
        path: /opt/deploy
        state: directory
        mode: '0755'

    - name: Копирование deploy-скрипта
      copy:
        content: |
          #!/bin/bash
          echo "Deploy script running on $(hostname)"
        dest: /opt/deploy/deploy.sh
        mode: '0755'

    - name: Настройка sudoers через template
      template:
        src: sudoers.j2
        dest: /etc/sudoers.d/ansible_sudo
        owner: root
        group: root
        mode: '0440'
      notify: Перезагрузка SSH (опционально)

  handlers:
    - name: Перезагрузка SSH
      systemd:
        name: sshd
        state: restarted
```

**Шаблон `templates/sudoers.j2`:**

```jinja2
# Сгенерировано Ansible
User_Alias OPERATORS = {% for u in sudo_users %}{{ u.name }}{% if not loop.last %}, {% endif %}{% endfor %}

Cmnd_Alias SYSCTL = /sbin/reboot, /bin/systemctl restart *, /bin/systemctl stop *, /bin/systemctl start *
Cmnd_Alias DEPLOY = /opt/deploy/*.sh

# Правила
{% for user in sudo_users %}
{{ user.name }} ALL = (root) {{ 'SYSCTL' if 'systemctl' in user.commands else 'DEPLOY' }}
{% endfor %}

# Полный доступ для группы admins
%admins ALL=(ALL) ALL
```

**Запуск:**

```bash
ansible-playbook -i inventory.ini setup_sudo.yml
```

---

### **Контрольные вопросы**
1. Зачем используется `sudo` вместо входа под `root`?
2. Почему нельзя редактировать `/etc/sudoers` напрямую?
3. Какие типы алиасов существуют в `sudoers`?
4. Что означает символ `%` в записи `%wheel`?
5. Как Ansible помогает в управлении политиками `sudo`?

---

### **Вывод**

В ходе лабораторной работы:
- Было изучено назначение и принцип работы `sudo`.
- Выполнена установка и настройка `sudo` в ALT Linux.
- Изучена структура файла `/etc/sudoers`, созданы алиасы.
- Реализовано разделение прав между пользователями и группами.
- Проверена работа ограничений на примере операторов и деплоеров.
- Выполнена автоматизация настройки с помощью Ansible.

Работа демонстрирует современный подход к безопасности: минимальные привилегии, аудит действий и централизованное управление.

---

**Примечания:**
- Всегда используйте `visudo` для редактирования `/etc/sudoers`.
- Логи `sudo` можно просматривать командой: `sudo grep sudo /var/log/secure`.
- При работе с Ansible убедитесь, что целевые машины доступны по SSH.
