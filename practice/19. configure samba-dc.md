**Лабораторная работа №19 по теме: Развертывание контроллера домена Samba AD с интеграцией BIND9 в ALT Linux**

---

### **Цель работы**  
Освоить процесс развертывания контроллера домена Active Directory на базе **Samba 4** в операционной системе **ALT Linux**, с интеграцией DNS-сервера **BIND9** через модуль **DLZ (Dynamic LDAP Zone)**. Научиться настраивать сетевые параметры, безопасность и проверять работоспособность доменной инфраструктуры.

---

### **Задачи работы**
1. Настроить имя хоста и обновить систему.
2. Установить и настроить DNS-сервер BIND9 с поддержкой Samba AD.
3. Интегрировать BIND9 с Samba через DLZ-модуль.
4. Подготовить систему к развертыванию контроллера домена.
5. Выполнить провизию (provision) домена с помощью `samba-tool`.
6. Запустить и проверить работу служб Samba и BIND.
7. Проверить корректность DNS-записей и доступность доменных ресурсов.
8. Подключить клиентский компьютер к домену.

---

### **Методические указания**

#### **Теоретическая часть**

**Samba AD DC** — реализация контроллера домена Microsoft Active Directory на базе открытого программного обеспечения Samba. Позволяет управлять пользователями, политиками, аутентификацией и DNS в гетерогенной среде.

**BIND9** — наиболее распространённый DNS-сервер в Unix-подобных системах. При использовании с Samba через **DLZ-модуль**, зоны хранятся не в файлах, а в каталоге **Samba AD (DIT)**, что обеспечивает централизованное управление.

**DLZ (Dynamic Zone Module)** — позволяет BIND9 читать DNS-записи напрямую из базы данных Samba, исключая необходимость ручного управления файлами зон.

**Ключевые компоненты:**
- `/etc/bind/named.conf` — основной конфигурационный файл BIND.
- `/var/lib/samba/bind-dns/` — каталог с ключами и конфигурацией для интеграции.
- `rndc` — утилита управления BIND (работает по защищённому каналу).
- `samba-tool` — консольная утилита для администрирования Samba AD.

---

### **Практическая часть**

---
#### **Подготовка инфраструктуры:**

Создать дополнительную виртуальную машину VM3 на основе alt workstation.

Настроить ip-адресс 10.0.0.30

#### **Шаг 1: Настройка имени хоста и обновление системы**

Установите имя хоста:

```bash
hostnamectl set-hostname SRV1.sisa.nmsgc
exec bash
```

Обновите список пакетов:

```bash
sudo apt-get update
```

---

#### **Шаг 2: Установка BIND9 и служебных утилит**

```bash
sudo apt-get install bind bind-utils -y
```

> `bind-utils` содержит утилиты `host`, `dig`, `nslookup`.

---

#### **Шаг 3: Настройка ACL и параметров DNS в `/etc/bind/options.conf`**

Откройте файл:

```bash
sudo nano /etc/bind/options.conf
```

Вставьте следующую конфигурацию:

```conf
acl internal { 10.0.0.0/24; };

options {
    tkey-gssapi-keytab "/var/lib/samba/bind-dns/dns.keytab";
    minimal-responses yes;

    listen-on { 127.0.0.1; 10.0.0.10; };
    //listen-on-v6 { ::1; };
    forward first;
    forwarders { 77.88.8.88; };
    allow-recursion { 127.0.0.1; internal; };
    allow-query { 127.0.0.1; internal; };

    logging {
        category lame-servers { null; };
    };
};
```

> Убедитесь, что IP-адрес `10.0.0.10` соответствует сетевому интерфейсу сервера.

---

#### **Шаг 4: Отключение chroot для BIND**

По умолчанию в ALT Linux BIND работает в **chroot-окружении** (`/var/named/chroot`). Это означает, что все пути отсчитываются от `/var/named/chroot/`, а не от `/`.

Чтобы упростить интеграцию с Samba, отключим chroot:

```bash
sudo control bind-chroot disabled
```

> Эта команда специфична для ALT Linux и управляет поведением службы BIND.

---

#### **Шаг 5: Отключение кэширования Kerberos-билетов**

Отредактируйте конфигурацию службы BIND:

```bash
sudo nano /etc/sysconfig/bind
```

Добавьте строку:

```conf
KRB5RCACHETYPE="none"
```

> Это предотвращает ошибки аутентификации при работе с GSS-TKEY.

---

#### **Шаг 6: Подключение DLZ-модуля Samba**

Интегрируем BIND с Samba AD:

```bash
echo 'include "/var/lib/samba/bind-dns/named.conf";' | sudo tee -a /etc/bind/named.conf
```

Остановите BIND (временно):

```bash
sudo systemctl disable --now bind
```

---

#### **Шаг 7: Подготовка системы к установке Samba AD**

Удалите старые файлы Samba (если есть):

```bash
sudo rm -f /etc/samba/smb.conf
sudo rm -rf /var/lib/samba
sudo rm -rf /var/cache/samba
```

Создайте каталог `sysvol` — он будет использоваться для групповых политик домена:

```bash
sudo mkdir -p /var/lib/samba/sysvol
```

---

#### **Шаг 8: Установка контроллера домена**

Установите пакет контроллера домена:

```bash
sudo apt-get install task-samba-dc -y
```

---

#### **Шаг 9: Настройка локального DNS-резолвинга**

Чтобы сервер разрешал имена через себя, добавьте в `/etc/resolvconf.conf`:

```bash
echo "name_servers='127.0.0.1'" | sudo tee -a /etc/resolvconf.conf
```

Обновите `/etc/resolv.conf`:

```bash
sudo resolvconf -u
```

Проверьте результат:

```bash
cat /etc/resolv.conf
```

> Должно быть: `nameserver 127.0.0.1`

---

#### **Шаг 10: Создание домена с помощью `samba-tool`**

Выполните провизию домена:

```bash
sudo samba-tool domain provision
```

В диалоге укажите:

- **Realm**: `SISA.NMSGC`
- **Domain**: `SISA`
- **Server Role**: `dc`
- **DNS backend**: `BIND9_DLZ`
- **Administrator password**: `P@ssw0rd`
- **Retype password**: `P@ssw0rd`

> Процесс создаст структуру каталогов, базу данных, ключи Kerberos и настройки DNS.

---

#### **Шаг 11: Запуск служб Samba и BIND**

Запустите Samba:

```bash
sudo systemctl enable --now samba
```

Проверьте конфигурацию BIND:

```bash
sudo named-checkconf
```

> Если ошибок нет — можно продолжать.

---

#### **Шаг 12: Генерация ключа `rndc` (если требуется)**

Если при запуске возникает ошибка `rndc: neither /etc/rndc.conf nor /etc/rndc.key found`, выполните:

```bash
sudo rndc-confgen >> /etc/rndc.key
```

Отредактируйте файл:

```bash
sudo nano /etc/rndc.key
```

Оставьте только:

```conf
key "rndc-key" {
    algorithm hmac-sha256;
    secret "<ваш_сгенерированный_ключ>";
};
```

> Удалите остальные строки (комментарии и блок `controls`).

---

#### **Шаг 13: Решение проблемы с запуском в p11 (опционально)**

Если служба `bind` не запускается (особенно в версиях ALT p11), создайте override:

```bash
sudo mkdir -p /etc/systemd/system/bind.service.d
sudo nano /etc/systemd/system/bind.service.d/override.conf
```

Содержимое файла:

```ini
[Service]
Environment="LDB_MODULES_DISABLE_DEEPBIND=1"
```

Перезагрузите демон systemd и попробуйте снова:

```bash
sudo systemctl daemon-reexec
sudo systemctl enable --now bind
```

Проверьте статус:

```bash
systemctl status bind
journalctl -xeu bind.service
```

---

#### **Шаг 14: Проверка работоспособности**

Выполните тестовые команды:

```bash
host -t A localhost 127.0.0.1
host -t PTR 127.0.0.1 127.0.0.1
```

Проверка домена:

```bash
samba-tool domain info 127.0.0.1
smbclient -L localhost -U administrator
```

Проверка DNS-записей:

```bash
host sisa.nmsgc
host -t SRV _kerberos._udp.sisa.nmsgc.
host -t SRV _ldap._tcp.sisa.nmsgc.
host -t A SRV1.sisa.nmsgc.
```

---

#### **Шаг 15: Копирование конфигурации Kerberos**

Конфигурация уже создана Samba. Скопируйте её:

```bash
sudo cp /var/lib/samba/private/krb5.conf /etc/krb5.conf
```

---

### **Задание для студента: Подключение клиентской машины к домену**

**Цель:** Присоединить клиент CLI1 к домену `SISA.NMSGC`.

**Выполнение:**

1. На клиенте **CLI1** установите пакет:

   ```bash
   sudo apt-get install task-auth-ad-sssd
   ```

2. Откройте **Центр Управления Системой** → **Пользователи** → **Аутентификация**.

3. Выберите:
   - Тип аутентификации: **Active Directory**
   - Имя домена: `sisa.nmsgc`
   - Аутентификация через: **SSSD**
   - Нажмите **Применить**

4. Введите пароль администратора: `P@ssw0rd`

5. Дождитесь сообщения о присоединении к домену.

> ⚠️ **Важно!** После присоединения:
> - Войдите под **локальным пользователем**.
> - Перезапустите сеть:  
>   ```bash
>   sudo systemctl restart network
>   ```
> - Только после этого доменные пользователи смогут входить в систему.

---

### **Контрольные вопросы**
1. Зачем используется модуль DLZ в интеграции BIND и Samba?
2. Что такое chroot и зачем его отключать при настройке BIND с Samba?
3. Какой порт использует служба Kerberos? Какие SRV-записи она требует?
4. Для чего нужен файл `rndc.key`?
5. Почему необходимо перезапускать сеть после добавления в домен?

---

### **Вывод**

В ходе лабораторной работы:
- Был настроен хост `SRV1.sisa.nmsgc` как контроллер домена на базе Samba 4.
- Успешно интегрирован DNS-сервер BIND9 с использованием DLZ-модуля.
- Выполнена провизия домена, настроены службы и проверена их работоспособность.
- Реализовано подключение клиентской машины к домену через SSSD.

Работа демонстрирует возможность построения полнофункциональной инфраструктуры Active Directory на базе свободного ПО в дистрибутиве ALT Linux.

---

**Примечания:**
- Все действия выполняются с учётом особенностей ALT Linux (например, `control bind-chroot`, `resolvconf`).
- При ошибках используйте `journalctl -xeu <service>` для диагностики.
- Резервируйте доступ к серверу (консоль гипервизора) перед критическими операциями.
