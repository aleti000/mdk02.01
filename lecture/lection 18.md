# Лекция 18: Виртуализация

## Цели и задачи
- Изучить основные принципы виртуализации.
- Разобраться с ролью гипервизоров в создании и управлении виртуальными машинами.
- Научиться устанавливать и настраивать KVM (Kernel-based Virtual Machine) в Linux.
- Понять процесс создания, запуска и управления виртуальными машинами.
- Изучить настройку сетей и хранилищ для виртуальных машин.

---

## Основной материал

### 1. Введение в виртуализацию

#### Что такое виртуализация?
Виртуализация — это технология, позволяющая создавать и управлять несколькими изолированными операционными системами (виртуальными машинами) на одном физическом сервере.

#### Зачем нужна виртуализация?
- Эффективное использование ресурсов сервера.
- Упрощение тестирования и разработки.
- Обеспечение изоляции между приложениями.
- Быстрое развертывание новых сред.

#### Типы виртуализации:
1. Полную виртуализацию: Гостевая система работает как независимая (например, KVM).
2. Паравиртуализация: Гостевая система знает о работе гипервизора (например, Xen).
3. Контейнерная виртуализация: Легковесная изоляция приложений (например, Docker).

---

### 2. Установка KVM

#### Что такое KVM?
KVM (Kernel-based Virtual Machine) — это модуль ядра Linux, который позволяет использовать Linux как гипервизор для запуска виртуальных машин.

#### Установка KVM
Для установки KVM в Linux используется пакетный менеджер. Например, в Ubuntu:

1. Обновите список пакетов:
   apt update
2. Установите необходимые пакеты:
   apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager

#### Проверка поддержки виртуализации
Проверьте, поддерживает ли процессор аппаратную виртуализацию:
egrep -c '(vmx|svm)' /proc/cpuinfo

Если результат больше 0, виртуализация поддерживается.

#### Запуск службы
Запустите службу libvirt:
systemctl start libvirtd
systemctl enable libvirtd

---

### 3. Создание виртуальной машины

#### Использование virt-manager
virt-manager — это графический интерфейс для управления виртуальными машинами.

1. Запустите virt-manager.
2. Создайте новую виртуальную машину:
   - Выберите образ ISO или существующий диск.
   - Настройте количество CPU, памяти и дискового пространства.
3. Запустите виртуальную машину.

#### Использование командной строки
Создайте виртуальную машину через командную строку:
virt-install \
   --name vm_name \
   --ram 2048 \
   --vcpus 2 \
   --disk path=/var/lib/libvirt/images/vm_name.qcow2,size=20 \
   --cdrom /path/to/iso \
   --graphics vnc

---

### 4. Управление виртуальными машинами

#### Запуск и остановка
Запустите виртуальную машину:
virsh start vm_name

Остановите виртуальную машину:
virsh shutdown vm_name

#### Просмотр списка виртуальных машин
Просмотрите список всех виртуальных машин:
virsh list --all

#### Удаление виртуальной машины
Удалите виртуальную машину:
virsh destroy vm_name
virsh undefine vm_name

---

### 5. Настройка сетей

#### Сетевые режимы
1. NAT: Виртуальная машина использует IP хоста.
2. Bridge: Виртуальная машина получает собственный IP в сети хоста.

#### Настройка Bridge
Создайте мостовую сеть:
auto br0
iface br0 inet dhcp
    bridge_ports eth0
    bridge_stp off
    bridge_fd 0
    bridge_maxwait 0

Примените изменения:
ifdown eth0 && ifup br0

---

### 6. Настройка хранилищ

#### Типы хранилищ
1. Локальные: Файлы образов на локальном диске.
2. Сетевые: NFS, iSCSI, Ceph.

#### Создание нового хранилища
Создайте новый образ диска:
qemu-img create -f qcow2 /var/lib/libvirt/images/vm_name.qcow2 20G

---

### 7. Пример создания виртуальной машины

#### Шаги:
1. Проверьте поддержку виртуализации:
   egrep -c '(vmx|svm)' /proc/cpuinfo
2. Установите KVM:
   apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager
3. Создайте виртуальную машину:
   virt-install \
      --name test_vm \
      --ram 2048 \
      --vcpus 2 \
      --disk path=/var/lib/libvirt/images/test_vm.qcow2,size=20 \
      --cdrom /path/to/ubuntu.iso \
      --graphics vnc
4. Запустите виртуальную машину:
   virsh start test_vm

---

## Домашнее задание
1. Установите KVM на виртуальной машине.
2. Создайте виртуальную машину с помощью virt-manager.
3. Настройте мостовую сеть для виртуальной машины.
4. Создайте новый образ диска и подключите его к виртуальной машине.
5. Изучите логи и найдите записи о работе виртуальной машины.

---

## Вопросы для самопроверки
1. Что такое виртуализация и для чего она используется?
2. Как установить и настроить KVM в Linux?
3. Как создать и запустить виртуальную машину?
4. Какие типы сетей можно использовать для виртуальных машин?
5. Какие инструменты можно использовать для управления виртуальными машинами?
