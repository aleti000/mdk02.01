# Лекция 6: Резервное копирование и создание снимков

## Цели и задачи
- Изучить основные методы резервного копирования данных.
- Разобраться с принципами создания снимков (snapshots) для быстрого восстановления.
- Понять важность планирования и автоматизации резервного копирования.
- Научиться применять знания для защиты данных в реальных условиях.

---

## Основной материал

### 1. Введение в резервное копирование

#### Что такое резервное копирование?
Резервное копирование — это процесс создания копий данных для их восстановления в случае потери или повреждения. Это один из ключевых аспектов управления данными и обеспечения их безопасности.

#### Зачем нужно резервное копирование?
- Защита от аппаратных сбоев (например, выход из строя жесткого диска).
- Восстановление после ошибок пользователя (например, случайное удаление важных файлов).
- Защита от программных сбоев (например, повреждение файловой системы).
- Защита от атак (например, вирусов или ransomware).

#### Типы резервного копирования:
1. Полное (Full Backup):
   - Копируются все данные.
   - Преимущества: Простота восстановления.
   - Недостатки: Занимает много времени и места.

2. Инкрементное (Incremental Backup):
   - Копируются только изменения с момента последнего бэкапа.
   - Преимущества: Экономит место и время.
   - Недостатки: Сложнее восстановление, так как требуется полный бэкап и все инкрементные копии.

3. Дифференциальное (Differential Backup):
   - Копируются изменения с момента последнего полного бэкапа.
   - Преимущества: Баланс между скоростью и объемом.
   - Недостатки: Занимает больше места, чем инкрементное копирование.

#### Где хранить резервные копии?
- Локально (на внешних носителях, таких как USB-диски).
- На сетевых хранилищах (NAS).
- В облачных сервисах (например, AWS S3, Google Cloud Storage).

---

### 2. Утилиты для резервного копирования

#### tar
Утилита tar используется для создания архивов. Она поддерживает сжатие данных и может быть использована для резервного копирования.

##### Принцип работы:
- Создание архива:
  tar -cvf backup.tar /path/to/directory
  -c: Создать новый архив.
  -v: Показать процесс создания архива.
  -f: Указать имя файла архива.

- Сжатие архива:
  tar -czvf backup.tar.gz /path/to/directory
  -z: Использовать сжатие gzip.

- Восстановление данных:
  tar -xvf backup.tar -C /restore/location
  -x: Извлечь файлы из архива.
  -C: Указать каталог для восстановления.

#### rsync
Утилита rsync используется для синхронизации данных. Она эффективна для создания инкрементных копий.

##### Принцип работы:
- Копирование данных:
  rsync -av /source/directory /destination/directory
  -a: Сохранить атрибуты файлов (режим, владелец, временные метки).
  -v: Показать процесс копирования.

- Копирование с удаленного сервера:
  rsync -av user@remote:/source/directory /local/destination

#### dd
Утилита dd используется для создания образов дисков. Она полезна для создания точных копий устройств.

##### Принцип работы:
- Создание образа диска:
  dd if=/dev/sdX of=/path/to/image.img bs=4M
  if: Входной файл (источник).
  of: Выходной файл (образ).
  bs: Размер блока для чтения/записи.

- Восстановление образа:
  dd if=/path/to/image.img of=/dev/sdX bs=4M

---

### 3. Создание снимков (Snapshots)

#### Что такое снимки?
Снимки (snapshots) — это точка восстановления системы или данных на определенный момент времени. Они позволяют быстро восстановить состояние системы без необходимости полного восстановления из резервной копии.

#### Инструменты для создания снимков:
1. LVM (Logical Volume Manager):
   - LVM позволяет создавать снимки логических томов.
   - Принцип работы:
     - Создается "замороженная" копия тома на момент создания снимка.
     - Снимок занимает место только для измененных данных.

2. Btrfs:
   - Файловая система Btrfs поддерживает встроенные снимки.
   - Принцип работы:
     - Снимок создается мгновенно и не требует дополнительного места до тех пор, пока данные не изменяются.

---

### 4. Автоматизация резервного копирования

#### Cron
Cron используется для автоматизации задач по расписанию. Это удобный инструмент для регулярного создания резервных копий.

##### Принцип работы:
1. Откройте редактор cron:
   crontab -e
2. Добавьте задачу для ежедневного бэкапа:
   0 2 * * * tar -czvf /backup/backup.tar.gz /important/data
   0 2 * * *: Задача выполняется каждый день в 2:00 утра.

#### systemd timers
Systemd timers — альтернатива cron для современных систем.

##### Принцип работы:
1. Создайте unit-файл:
   /etc/systemd/system/backup.timer
   Содержимое:
   [Unit]
   Description=Daily Backup Timer

   [Timer]
   OnCalendar=daily
   Persistent=true

   [Install]
   WantedBy=timers.target
2. Создайте service-файл:
   /etc/systemd/system/backup.service
   Содержимое:
   [Unit]
   Description=Backup Service

   [Service]
   ExecStart=/usr/bin/tar -czvf /backup/backup.tar.gz /important/data

3. Активируйте таймер:
   systemctl enable backup.timer
   systemctl start backup.timer

---

### 5. Восстановление данных

#### Этапы восстановления:
1. Определите источник бэкапа.
2. Извлеките данные:
   tar -xvf backup.tar -C /restore/location
3. Проверьте целостность восстановленных данных.

---

## Домашнее задание
1. Изучите команду tar и попробуйте создать архив с данными.
2. Настройте автоматическое резервное копирование с помощью cron.
3. Изучите принципы работы LVM и Btrfs для создания снимков.
4. Подумайте, какие данные в вашей системе требуют регулярного резервного копирования.

---

## Вопросы для самопроверки
1. Какие типы резервного копирования существуют?
2. Для чего используются утилиты tar, rsync и dd?
3. Что такое снимки (snapshots) и как они создаются?
4. Как настроить автоматическое резервное копирование?
5. Как восстановить данные из резервной копии?
