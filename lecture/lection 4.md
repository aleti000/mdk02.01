# Лекция 4: Управление пользователями и группами

## Цели и задачи
- Научиться создавать и управлять пользователями в Linux.
- Изучить принципы работы с группами.
- Разобраться с правами доступа и их управлением.
- Понять, как работает аутентификация и авторизация в Linux.

## Основной материал

---

### 1. Что такое пользователи и группы?

#### Пользователи:
Пользователь — это учетная запись, которая позволяет взаимодействовать с системой. Каждый пользователь имеет уникальный идентификатор (UID).
Типы пользователей:
- Системные пользователи: Используются для запуска служб и демонов (например, root, www-data). Эти пользователи обычно не имеют пароля и не предназначены для входа в систему.
- Обычные пользователи: Создаются для людей, работающих с системой. Они могут входить в систему и выполнять задачи.

UID (User ID):
UID — это уникальный числовой идентификатор пользователя. Например:
- root всегда имеет UID = 0.
- Обычные пользователи обычно имеют UID > 1000.
Файл /etc/passwd содержит информацию о пользователях, включая их UID.

#### Группы:
Группа — это набор пользователей, объединенных для управления правами доступа. Каждая группа имеет уникальный идентификатор (GID).
Принцип работы:
- Пользователи могут входить в несколько групп.
- Права доступа можно назначать не только отдельным пользователям, но и целым группам.
Файл /etc/group содержит информацию о группах, включая их GID.

Пример:
Чтобы посмотреть список всех пользователей, используйте команду:
cat /etc/passwd

Чтобы посмотреть список всех групп, используйте команду:
cat /etc/group

Дополнительные файлы:
- /etc/shadow: Содержит хэши паролей пользователей. Этот файл защищен и доступен только для чтения администратором.
- /etc/gshadow: Содержит пароли групп (если они используются).

---

### 2. Создание и управление пользователями

Команды для работы с пользователями:
- useradd: Создание нового пользователя.
- usermod: Изменение параметров пользователя.
- userdel: Удаление пользователя.
- passwd: Установка или изменение пароля пользователя.

Пример создания пользователя:
Создайте нового пользователя:
useradd alice

Установите пароль для пользователя:
passwd alice

Изменение параметров пользователя:
Измените домашнюю директорию пользователя:
usermod -d /new/home/alice alice

Добавьте пользователя в группу:
usermod -aG developers alice

Удаление пользователя:
Удалите пользователя вместе с его домашней директорией:
userdel -r alice

---

### 3. Создание и управление группами

Команды для работы с группами:
- groupadd: Создание новой группы.
- groupmod: Изменение параметров группы.
- groupdel: Удаление группы.

Пример создания группы:
Создайте новую группу:
groupadd developers

Добавьте пользователя в группу:
usermod -aG developers alice

Изменение параметров группы:
Измените имя группы:
groupmod -n dev_team developers

Удаление группы:
Удалите группу:
groupdel developers

---

### 4. Права доступа

Права доступа определяют, кто может читать, записывать или выполнять файл. Они делятся на три категории:
- Владелец (user): Пользователь, создавший файл.
- Группа (group): Группа, которой принадлежит файл.
- Остальные (others): Все остальные пользователи.

Типы прав:
- r (read): Чтение.
- w (write): Запись.
- x (execute): Выполнение.

Битовые значения:
Права представлены в виде чисел:
- r = 4
- w = 2
- x = 1

Пример:
Права 755 означают:
- Владелец: rwx (7 = 4 + 2 + 1)
- Группа: r-x (5 = 4 + 1)
- Остальные: r-x (5 = 4 + 1)

Команды:
- chmod: Изменение прав доступа.
- chown: Изменение владельца файла.
- chgrp: Изменение группы файла.

Пример изменения прав:
Измените права доступа к файлу:
chmod 755 file.txt

Измените владельца файла:
chown alice file.txt

Измените группу файла:
chgrp developers file.txt

---

### 5. Специальные права доступа

SUID (Set User ID):
Описание: SUID разрешает выполнение файла с правами владельца, а не с правами пользователя, который его запускает.
Принцип работы:
- Когда установлен бит SUID, файл выполняется с правами владельца, даже если его запускает другой пользователь.
- Это полезно для программ, которые требуют повышенных привилегий (например, passwd).
Установка SUID:
chmod u+s file.txt
Пример:
ls -l /usr/bin/passwd
-rwsr-xr-x 1 root root 68208 Oct 10 12:34 /usr/bin/passwd
Буква s указывает на наличие SUID.

SGID (Set Group ID):
Описание: SGID разрешает выполнение файла с правами группы, а не с правами пользователя, который его запускает.
Принцип работы:
- Если SGID установлен на директорию, все новые файлы в этой директории будут принадлежать группе, которой принадлежит сама директория.
- Это полезно для совместного использования файлов в группах.
Установка SGID:
chmod g+s directory/
Пример:
mkdir shared_directory
chmod g+s shared_directory/

Sticky Bit:
Описание: Sticky Bit защищает файлы в директории от удаления другими пользователями. Только владелец файла или root может удалить файл.
Принцип работы:
- Sticky Bit часто используется для временных директорий, таких как /tmp.
Установка Sticky Bit:
chmod +t /tmp
Пример:
ls -ld /tmp
drwxrwxrwt 10 root root 4096 Oct 10 12:34 /tmp
Буква t указывает на наличие Sticky Bit.

Риски использования SUID и SGID:
Неправильное использование SUID и SGID может привести к уязвимостям безопасности.
Рекомендуется минимизировать количество файлов с этими битами.

---

### 6. Аутентификация и авторизация

Аутентификация:
Определение: Процесс проверки подлинности пользователя (например, ввод логина и пароля).
Файлы конфигурации:
- /etc/passwd: Содержит информацию о пользователях, включая их UID, GID, домашнюю директорию и оболочку.
alice:x:1001:1001:Alice:/home/alice:/bin/bash
Поле x указывает, что пароль хранится в /etc/shadow.
- /etc/shadow: Содержит хэши паролей пользователей.
alice:$6$randomstring$hash:18295:0:99999:7:::
Здесь $6 указывает на алгоритм хэширования (SHA-512).

Авторизация:
Определение: Процесс определения прав доступа пользователя после успешной аутентификации.
Механизмы авторизации:
- Права доступа: Управление доступом к файлам и директориям.
- sudo: Позволяет пользователям выполнять команды с правами root.
Файл /etc/sudoers определяет, какие пользователи могут использовать sudo.
Пример:
alice ALL=(ALL) NOPASSWD: ALL

Безопасность аутентификации:
Хэширование паролей:
- Пароли хранятся в виде хэшей, чтобы защитить их от несанкционированного доступа.
- Алгоритмы хэширования: MD5, SHA-256, SHA-512.
Shadow passwords:
- Пароли хранятся в /etc/shadow, а не в /etc/passwd, чтобы предотвратить доступ обычных пользователей к хэшам.

Пример:
Чтобы посмотреть хэши паролей, используйте команду:
sudo cat /etc/shadow

---

### 7. Принцип и назначение sudoers

Что такое sudoers?
Файл /etc/sudoers определяет, какие пользователи или группы могут выполнять команды с повышенными привилегиями (например, с правами root). Это ключевой механизм для управления доступом к административным функциям системы.

Принцип работы:
Правила доступа:
- Каждая строка в файле /etc/sudoers описывает правило, которое определяет, кто может выполнять какие команды.
- Правила могут быть настроены для отдельных пользователей или групп.
Синтаксис:
user_or_group HOST=(AS_USER) COMMANDS
- user_or_group: Имя пользователя или группы.
- HOST: Хост, на котором применяется правило.
- (AS_USER): Пользователь, от имени которого выполняется команда (обычно root).
- COMMANDS: Команды, которые разрешено выполнять.

Примеры правил:
1. Разрешить пользователю alice выполнять любые команды как root:
alice ALL=(ALL) ALL
2. Разрешить пользователю bob выполнять только команду /bin/systemctl restart sshd без ввода пароля:
bob ALL=(ALL) NOPASSWD: /bin/systemctl restart sshd
3. Разрешить группе admins выполнять любые команды как root:
%admins ALL=(ALL) ALL

Безопасность:
Редактирование файла:
- Никогда не редактируйте файл /etc/sudoers напрямую. Вместо этого используйте команду:
visudo
Эта команда проверяет синтаксис перед сохранением файла, чтобы избежать ошибок.
Ограничения:
- Минимизируйте количество пользователей с доступом к sudo.
- Указывайте только те команды, которые действительно необходимы.

Пример использования:
Откройте файл /etc/sudoers для редактирования:
visudo
Добавьте правило для пользователя alice:
alice ALL=(ALL) NOPASSWD: /usr/bin/apt update
Сохраните файл и выйдите.

Теперь пользователь alice может обновлять список пакетов без ввода пароля:
sudo apt update

---

### 8. Безопасность учетных записей

Рекомендации:
1. Используйте сложные пароли:
   - Минимум 8 символов.
   - Включайте буквы, цифры и специальные символы.
2. Ограничьте права root:
   - Не работайте под учетной записью root.
   - Используйте sudo для выполнения административных задач.
3. Регулярно проверяйте учетные записи:
   - Удаляйте неиспользуемые учетные записи.
   - Проверяйте файлы /etc/passwd и /etc/shadow.

Пример:
Заблокируйте учетную запись пользователя:
passwd -l alice

Разблокируйте учетную запись пользователя:
passwd -u alice

---

## Домашнее задание
1. Создайте нового пользователя и группу.
2. Добавьте пользователя в группу.
3. Измените права доступа к файлу.
4. Установите SUID, SGID и Sticky Bit на тестовые файлы.
5. Настройте правила в файле /etc/sudoers для нового пользователя.
6. Проверьте содержимое файлов /etc/passwd и /etc/shadow.

## Вопросы для самопроверки
1. Как создать нового пользователя в Linux?
2. Как добавить пользователя в группу?
3. Как изменить права доступа к файлу?
4. Что такое SUID, SGID и Sticky Bit?
5. Как заблокировать учетную запись пользователя?
6. Для чего используется файл /etc/sudoers?
7. Как настроить права доступа через sudoers?
