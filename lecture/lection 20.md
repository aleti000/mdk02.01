# Лекция 20: Настройка файрвола

## Цели и задачи
- Изучить основные принципы работы файрвола.
- Разобраться с ролью файрвола в защите системы от несанкционированного доступа.
- Научиться устанавливать и настраивать файрвол (например, `iptables`, `ufw`, `firewalld`) в Linux.
- Понять процесс создания правил для управления сетевым трафиком.
- Изучить диагностику и устранение неисправностей в работе файрвола.

---

## Основной материал

### 1. Введение в файрволы

#### Что такое файрвол?
Файрвол (межсетевой экран) — это инструмент для контроля входящего и исходящего сетевого трафика. Он позволяет разрешать или блокировать соединения на основе правил.

#### Зачем нужен файрвол?
- Защита от несанкционированного доступа.
- Блокировка нежелательного трафика.
- Управление доступом к сетевым сервисам.

#### Основные типы файрволов:
1. **Пакетные фильтры**: Анализируют сетевые пакеты (например, `iptables`).
2. **Прокси-файрволы**: Работают на уровне приложений (например, Squid).
3. **Межсетевые экраны нового поколения (NGFW)**: Объединяют функции традиционных файрволов с анализом трафика.

---

### 2. Установка и настройка файрвола

#### Используемые инструменты:
1. **UFW (Uncomplicated Firewall)**: Простой интерфейс для управления правилами.
2. **iptables**: Низкоуровневый инструмент для настройки правил.
3. **firewalld**: Динамический менеджер правил для работы с зонами и службами.

---

#### 2.1. Настройка UFW

##### Установка UFW
Для установки UFW в Linux используется пакетный менеджер. Например, в Ubuntu:

1. Обновите список пакетов:
   apt update
2. Установите UFW:
   apt install ufw

##### Включение и отключение UFW
Включите файрвол:
ufw enable

Отключите файрвол:
ufw disable

##### Просмотр статуса
Проверьте статус файрвола:
ufw status

##### Создание правил
Разрешите входящий трафик на порт 22 (SSH):
ufw allow 22

Разрешите входящий трафик на диапазон портов:
ufw allow 8000:9000/tcp

Заблокируйте входящий трафик на порт 80:
ufw deny 80

Удалите правило:
ufw delete allow 22

---

#### 2.2. Настройка iptables

##### Просмотр текущих правил
Просмотрите текущие правила:
iptables -L

##### Добавление правил
Разрешите входящий трафик на порт 80:
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

Заблокируйте входящий трафик на порт 22:
iptables -A INPUT -p tcp --dport 22 -j DROP

##### Сохранение правил
Сохраните правила для загрузки при старте системы:
iptables-save > /etc/iptables/rules.v4

---

#### 2.3. Настройка firewalld

##### Что такое firewalld?
`firewalld` — это динамический менеджер файрвола, который использует концепцию **зон** для управления правилами. Каждая зона определяет уровень доверия к сети (например, `public`, `internal`, `trusted`).

##### Установка firewalld
Для установки firewalld в Linux используется пакетный менеджер. Например, в CentOS или RHEL:

1. Обновите список пакетов:
   yum update
2. Установите firewalld:
   yum install firewalld

##### Запуск и включение firewalld
Запустите службу:
systemctl start firewalld

Добавьте службу в автозагрузку:
systemctl enable firewalld

##### Просмотр статуса
Проверьте статус службы:
systemctl status firewalld

Просмотрите активные зоны:
firewall-cmd --get-active-zones

##### Управление зонами
Просмотрите список зон:
firewall-cmd --get-zones

Просмотрите правила для зоны:
firewall-cmd --zone=public --list-all

Измените зону для интерфейса:
firewall-cmd --zone=internal --change-interface=eth0

##### Добавление правил
Разрешите входящий трафик на порт 22 (SSH):
firewall-cmd --zone=public --add-port=22/tcp --permanent

Разрешите службу HTTP:
firewall-cmd --zone=public --add-service=http --permanent

Обновите правила:
firewall-cmd --reload

##### Удаление правил
Удалите правило для порта:
firewall-cmd --zone=public --remove-port=22/tcp --permanent

Удалите службу:
firewall-cmd --zone=public --remove-service=http --permanent

Обновите правила:
firewall-cmd --reload

##### Создание пользовательских зон
Создайте новую зону:
firewall-cmd --new-zone=myzone --permanent

Добавьте интерфейс в зону:
firewall-cmd --zone=myzone --add-interface=eth1 --permanent

---

### 3. Диагностика и устранение неисправностей

#### Проверка активных соединений
Используйте `netstat` или `ss` для просмотра активных соединений:
netstat -tuln
ss -tuln

#### Просмотр логов
Логи файрвола можно найти в системных журналах:
tail -f /var/log/syslog

#### Распространенные проблемы:
- Неправильные правила блокировки.
- Конфликты между правилами.
- Отсутствие сохранения правил после перезагрузки.

---

### 4. Безопасность файрвола

#### Ограничение доступа
Разрешите доступ только из доверенных IP-адресов:
ufw allow from 192.168.1.10 to any port 22

#### Блокировка всего входящего трафика
Блокируйте весь входящий трафик по умолчанию:
iptables -P INPUT DROP

#### Разрешение исходящего трафика
Разрешите весь исходящий трафик:
iptables -P OUTPUT ACCEPT

---

### 5. Пример настройки файрвола

#### Шаги:
1. Установите UFW:
   apt install ufw
2. Разрешите SSH:
   ufw allow 22
3. Разрешите HTTP и HTTPS:
   ufw allow 80
   ufw allow 443
4. Включите файрвол:
   ufw enable
5. Проверьте статус:
   ufw status

#### Альтернатива с firewalld:
1. Установите firewalld:
   yum install firewalld
2. Разрешите SSH:
   firewall-cmd --zone=public --add-service=ssh --permanent
3. Разрешите HTTP и HTTPS:
   firewall-cmd --zone=public --add-service=http --permanent
   firewall-cmd --zone=public --add-service=https --permanent
4. Обновите правила:
   firewall-cmd --reload
5. Проверьте статус:
   firewall-cmd --zone=public --list-all

---

## Домашнее задание
1. Установите и настройте UFW на виртуальной машине.
2. Разрешите доступ к SSH, HTTP и HTTPS.
3. Заблокируйте входящий трафик на порт 8080.
4. Установите и настройте firewalld на другой машине.
5. Создайте пользовательскую зону в firewalld и добавьте правила для нее.

---

## Вопросы для самопроверки
1. Что такое файрвол и для чего он используется?
2. Как установить и настроить UFW в Linux?
3. Как создавать правила для управления сетевым трафиком в iptables?
4. Как работает firewalld и какие преимущества он предоставляет?
5. Какие меры безопасности можно применить для защиты системы с помощью файрвола?
