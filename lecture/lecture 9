# Лекция 9: Протокол DNS

## Цели и задачи
- Изучить основные принципы работы протокола DNS.
- Разобраться с ролью DNS в разрешении доменных имен.
- Научиться устанавливать и настраивать DNS-сервер (BIND) в Linux.
- Понять процесс диагностики и устранения неисправностей в работе DNS.
- Изучить историческую справку о зарождении DNS и роли файла hosts.

---

## Основной материал

### 1. Введение в протокол DNS

#### Что такое DNS?
DNS (Domain Name System) — это распределенная система, которая преобразует доменные имена (например, example.com) в IP-адреса (например, 192.168.1.1). Это позволяет пользователям обращаться к ресурсам в интернете по удобным для запоминания именам, а не по сложным числовым адресам.

#### Зачем нужен DNS?
- Упрощение доступа к ресурсам в интернете.
- Централизованное управление доменными именами.
- Поддержка масштабируемости интернета.

---

### 2. Историческая справка: от файла hosts к DNS

#### Файл hosts
До появления DNS для сопоставления доменных имен и IP-адресов использовался файл hosts. Этот файл содержал список соответствий между именами и адресами.

##### Пример файла hosts:
127.0.0.1       localhost
192.168.1.10    server.example.com

##### Проблемы файла hosts:
- Ручное управление: каждый компьютер должен был иметь собственный файл hosts.
- Невозможность масштабирования: с ростом количества устройств и доменов поддержка файла стала непрактичной.

#### Зарождение DNS
В 1983 году Пол Мокапетрис предложил систему DNS для решения проблем масштабирования. DNS стал распределенной системой, где информация о доменах хранится на множестве серверов по всему миру.

##### Преимущества DNS:
- Автоматизация разрешения имен.
- Распределенность: данные хранятся на множестве серверов.
- Гибкость: поддержка различных типов записей (A, CNAME, MX и т.д.).

---

### 3. Как работает DNS?

#### Процесс разрешения имени
1. Клиент отправляет запрос:
   - Пользователь вводит доменное имя (например, example.com) в браузере.
2. Локальный DNS-сервер:
   - Запрос отправляется на локальный DNS-сервер (например, провайдера).
3. Рекурсивный запрос:
   - Если локальный сервер не знает ответ, он отправляет рекурсивный запрос на корневые DNS-серверы.
4. Поиск зоны:
   - Корневые серверы направляют запрос к TLD-серверам (например, .com).
   - TLD-серверы направляют запрос к авторитетному DNS-серверу домена.
5. Получение ответа:
   - Авторитетный сервер возвращает IP-адрес домена.

---

### 4. Установка и настройка DNS-сервера (BIND)

#### Установка BIND
Для установки DNS-сервера в Linux используется пакет BIND (Berkeley Internet Name Domain).

##### Шаги:
1. Установите пакет:
   apt install bind9
2. Настройте конфигурационный файл:
   /etc/bind/named.conf.local

##### Пример конфигурации зоны:
zone "example.com" {
    type master;
    file "/etc/bind/db.example.com";
};

zone "1.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/db.192.168.1";
};

#### Создание файла зоны
1. Файл прямой зоны (/etc/bind/db.example.com):
   $TTL    604800
   @       IN      SOA     ns1.example.com. admin.example.com. (
                              2023101001 ; Serial
                              604800     ; Refresh
                              86400      ; Retry
                              2419200    ; Expire
                              604800 )   ; Negative Cache TTL
   ;
   @       IN      NS      ns1.example.com.
   @       IN      A       192.168.1.10
   ns1     IN      A       192.168.1.10
   www     IN      A       192.168.1.10

2. Файл обратной зоны (/etc/bind/db.192.168.1):
   $TTL    604800
   @       IN      SOA     ns1.example.com. admin.example.com. (
                              2023101001 ; Serial
                              604800     ; Refresh
                              86400      ; Retry
                              2419200    ; Expire
                              604800 )   ; Negative Cache TTL
   ;
   @       IN      NS      ns1.example.com.
   10      IN      PTR     ns1.example.com.

#### Запуск службы
1. Проверьте конфигурацию:
   named-checkconf
2. Проверьте файлы зон:
   named-checkzone example.com /etc/bind/db.example.com
   named-checkzone 1.168.192.in-addr.arpa /etc/bind/db.192.168.1
3. Запустите службу:
   systemctl start bind9
4. Добавьте службу в автозагрузку:
   systemctl enable bind9

---

### 5. Типы DNS-записей

DNS поддерживает множество типов записей, каждая из которых выполняет свою функцию:

1. **A**: Сопоставляет доменное имя с IPv4-адресом.
   - Пример:
     www.example.com. IN A 192.168.1.10

2. **AAAA**: Сопоставляет доменное имя с IPv6-адресом.
   - Пример:
     www.example.com. IN AAAA 2001:db8::1

3. **CNAME**: Создает псевдоним для доменного имени.
   - Пример:
     ftp.example.com. IN CNAME www.example.com.

4. **MX**: Указывает почтовый сервер для домена.
   - Пример:
     example.com. IN MX 10 mail.example.com.

5. **NS**: Указывает авторитетные DNS-серверы для зоны.
   - Пример:
     example.com. IN NS ns1.example.com.

6. **PTR**: Используется для обратного разрешения (IP -> имя).
   - Пример:
     10.1.168.192.in-addr.arpa. IN PTR ns1.example.com.

7. **TXT**: Содержит произвольные текстовые данные (например, для SPF или DKIM).
   - Пример:
     example.com. IN TXT "v=spf1 mx ~all"

8. **SOA**: Определяет параметры зоны (начало полномочий).
   - Пример:
     @ IN SOA ns1.example.com. admin.example.com. (
         2023101001 ; Serial
         604800     ; Refresh
         86400      ; Retry
         2419200    ; Expire
         604800 )   ; Negative Cache TTL

---

### 6. Принцип работы зон

#### Что такое зона?
Зона — это часть пространства имен DNS, управляемая одним DNS-сервером. Каждая зона содержит записи для определенного домена и его поддоменов.

#### Типы зон:
1. **Прямая зона**:
   - Отвечает за преобразование доменных имен в IP-адреса.
   - Пример: example.com -> 192.168.1.10.

2. **Обратная зона**:
   - Отвечает за преобразование IP-адресов в доменные имена.
   - Пример: 192.168.1.10 -> ns1.example.com.

#### Принцип делегирования:
- Большие домены могут быть разделены на подзоны, которые управляются разными DNS-серверами.
- Например, домен example.com может делегировать поддомен sub.example.com другому DNS-серверу.

#### Файл зоны:
- Файл зоны содержит все записи для конкретной зоны.
- Пример структуры файла зоны:
  $TTL    604800
  @       IN      SOA     ns1.example.com. admin.example.com. (
                             2023101001 ; Serial
                             604800     ; Refresh
                             86400      ; Retry
                             2419200    ; Expire
                             604800 )   ; Negative Cache TTL
  ;
  @       IN      NS      ns1.example.com.
  @       IN      A       192.168.1.10
  ns1     IN      A       192.168.1.10
  www     IN      A       192.168.1.10

---

### 7. Диагностика и устранение неисправностей

#### Проверка работы DNS
1. Проверьте статус службы:
   systemctl status bind9
2. Просмотрите логи:
   journalctl -u bind9

#### Тестирование DNS
1. Выполните запрос DNS:
   dig example.com
2. Проверьте обратное разрешение:
   dig -x 192.168.1.10

#### Распространенные проблемы:
- Ошибки в конфигурации зон.
- Отсутствие связи с авторитетными серверами.
- Конфликты записей.

---

### 8. Безопасность DNS

#### Защита DNS-сервера
1. Ограничение доступа:
   - Разрешите только доверенные сети.
   - Настройте файрвол для защиты порта 53.
2. Защита от атак:
   - Предотвращайте атаки типа "DNS Spoofing" с помощью DNSSEC.
   - Используйте инструменты мониторинга для обнаружения аномалий.

---

## Домашнее задание
1. Установите и настройте DNS-сервер (BIND) на виртуальной машине.
2. Создайте прямую и обратную зоны для домена example.com.
3. Добавьте различные типы записей (A, CNAME, MX, TXT) в файл зоны.
4. Проверьте работу DNS с помощью команды dig.
5. Изучите логи DNS-сервера и найдите записи о запросах.

---

## Вопросы для самопроверки
1. Что такое DNS и для чего он используется?
2. Какие типы DNS-записей существуют? Для чего они нужны?
3. Как установить и настроить DNS-сервер (BIND)?
4. Как проверить работу DNS?
5. Какие меры безопасности можно применить для защиты DNS-сервера?
6. Какую роль играл файл hosts до появления DNS?
7. Что такое зона DNS? Какие типы зон существуют?

---
