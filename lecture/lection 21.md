# Лекция 21: Работа с RAID

## Цели и задачи
- Изучить основные принципы работы RAID (Redundant Array of Independent Disks).
- Разобраться с типами RAID и их особенностями.
- Научиться создавать и управлять RAID-массивами в Linux.
- Понять процесс восстановления данных в случае сбоя диска.
- Изучить диагностику и устранение неисправностей в работе RAID.
- Узнать о преимуществах аппаратного RAID, BBU, HotSwap и HotSpare.

---

## Основной материал

### 1. Введение в RAID

#### Что такое RAID?
RAID (Redundant Array of Independent Disks) — это технология объединения нескольких физических дисков в один логический том для повышения производительности, отказоустойчивости или обоих параметров.

#### Зачем нужен RAID?
- Увеличение производительности (например, RAID 0).
- Обеспечение отказоустойчивости (например, RAID 1, RAID 5).
- Баланс между производительностью и надежностью (например, RAID 10).

---

### 2. Уровни RAID: Подробное описание

#### RAID 0 (Striping)
- **Описание**: Данные разделяются на блоки и записываются параллельно на несколько дисков.
- **Преимущества**:
  - Высокая производительность за счет чередования данных.
  - Полное использование дискового пространства.
- **Недостатки**:
  - Нет избыточности. При выходе из строя одного диска теряются все данные.
- **Использование**: Подходит для задач, где важна скорость, но не критична надежность (например, рендеринг видео).

#### RAID 1 (Mirroring)
- **Описание**: Данные дублируются на два или более дисков.
- **Преимущества**:
  - Высокая отказоустойчивость. Данные доступны даже при выходе из строя одного диска.
  - Простота реализации.
- **Недостатки**:
  - Используется только половина дискового пространства.
- **Использование**: Подходит для критически важных данных (например, базы данных).

#### RAID 5 (Striping with Parity)
- **Описание**: Данные и контрольная информация (четность) распределяются по всем дискам.
- **Преимущества**:
  - Хороший баланс между производительностью и отказоустойчивостью.
  - Возможность восстановления данных при выходе из строя одного диска.
- **Недостатки**:
  - Требует минимум 3 дисков.
  - Производительность записи ниже, чем у RAID 0 или RAID 1.
- **Использование**: Подходит для файловых серверов и систем хранения данных.

#### RAID 6 (Striping with Double Parity)
- **Описание**: Аналог RAID 5, но с двойной четностью. Допускает выход из строя двух дисков.
- **Преимущества**:
  - Высокая отказоустойчивость.
  - Поддержка больших массивов.
- **Недостатки**:
  - Требует минимум 4 дисков.
  - Сложнее в реализации.
- **Использование**: Подходит для крупных хранилищ данных.

#### RAID 10 (Mirroring + Striping)
- **Описание**: Комбинация RAID 1 и RAID 0. Данные зеркалируются, а затем чередуются.
- **Преимущества**:
  - Высокая производительность и отказоустойчивость.
  - Возможность восстановления данных при выходе из строя одного или нескольких дисков.
- **Недостатки**:
  - Высокая стоимость (используется только половина дискового пространства).
- **Использование**: Подходит для высоконагруженных систем (например, базы данных, виртуализация).

---

### 3. Аппаратный RAID, BBU, HotSwap, HotSpare

#### Аппаратный RAID
Аппаратный RAID реализуется с помощью специализированных RAID-контроллеров. Преимущества:
- Высокая производительность благодаря выделенному процессору.
- Независимость от операционной системы.
- Поддержка дополнительных функций, таких как кэширование и BBU.

#### BBU (Battery Backup Unit)
- **Описание**: Аккумуляторная батарея, которая защищает данные в кэше RAID-контроллера при внезапном отключении питания.
- **Преимущества**:
  - Защита данных в кэше до восстановления питания.
  - Предотвращение потери данных при записи.
- **Использование**: Критически важен для RAID 5 и RAID 6, где четность требует времени для расчета.

#### HotSwap
- **Описание**: Возможность замены неисправного диска без отключения системы.
- **Преимущества**:
  - Минимизация простоя.
  - Удобство обслуживания.
- **Требования**:
  - Поддержка HotSwap контроллером и корпусом сервера.

#### HotSpare
- **Описание**: Резервный диск, который автоматически подключается к массиву при выходе из строя основного диска.
- **Преимущества**:
  - Автоматическое восстановление массива.
  - Минимизация времени простоя.
- **Использование**: Рекомендуется для критически важных систем.

---

### 4. Вывод списка дисков

#### Как вывести список дисков?
Для просмотра доступных дисков используйте следующие команды:

1. Просмотр всех блочных устройств:
   lsblk

2. Просмотр дисков с подробной информацией:
   fdisk -l

3. Проверка состояния дисков через `smartctl`:
   smartctl -a /dev/sda

---

### 5. Подготовка дисков перед добавлением в RAID

#### Почему важно подготовить диски?
Перед добавлением дисков в RAID необходимо очистить их от старых данных и разделов, чтобы избежать конфликтов.

#### Шаги подготовки:
1. Проверьте текущие разделы на диске:
   fdisk -l /dev/sdb

2. Очистите диск от старых данных:
   dd if=/dev/zero of=/dev/sdb bs=1M count=100

3. Создайте новый раздел (если требуется):
   fdisk /dev/sdb
   - Выберите `n` для создания нового раздела.
   - Сохраните изменения командой `w`.

4. Проверьте результат:
   fdisk -l /dev/sdb

---

### 6. Создание RAID-массива

#### Используемые инструменты:
1. **mdadm**: Утилита для создания и управления RAID-массивами в Linux.

#### Установка mdadm
Для установки `mdadm` в Linux используется пакетный менеджер. Например, в Ubuntu:

1. Обновите список пакетов:
   apt update
2. Установите mdadm:
   apt install mdadm

#### Создание RAID-массива
Создайте RAID-массив уровня 1 (зеркало):
mdadm --create --verbose /dev/md0 --level=1 --raid-devices=2 /dev/sdb /dev/sdc

#### Просмотр состояния RAID
Проверьте состояние RAID-массива:
cat /proc/mdstat

Или используйте команду:
mdadm --detail /dev/md0

#### Сохранение конфигурации
Сохраните конфигурацию RAID для загрузки при старте системы:
mdadm --detail --scan > /etc/mdadm/mdadm.conf

Обновите initramfs:
update-initramfs -u

---

### 7. Монтирование RAID-массива

#### Создание файловой системы
Создайте файловую систему на RAID-массиве:
mkfs.ext4 /dev/md0

#### Создание точки монтирования
Создайте директорию для монтирования:
mkdir /mnt/raid

#### Монтирование RAID-массива
Монтируйте RAID-массив:
mount /dev/md0 /mnt/raid

#### Автоматическое монтирование
Добавьте запись в `/etc/fstab` для автоматического монтирования:
/dev/md0 /mnt/raid ext4 defaults 0 0

Проверьте корректность:
mount -a

---

### 8. Управление RAID-массивом

#### Добавление диска
Добавьте новый диск в RAID-массив:
mdadm --add /dev/md0 /dev/sdd

#### Удаление диска
Удалите диск из RAID-массива:
mdadm --remove /dev/md0 /dev/sdb

#### Остановка RAID-массива
Остановите RAID-массив:
mdadm --stop /dev/md0

#### Удаление RAID-массива
Удалите RAID-массив:
mdadm --zero-superblock /dev/sdb
mdadm --zero-superblock /dev/sdc

---

### 9. Восстановление данных

#### Замена неисправного диска
Если диск вышел из строя, замените его новым:
1. Удалите неисправный диск:
   mdadm --remove /dev/md0 /dev/sdb
2. Добавьте новый диск:
   mdadm --add /dev/md0 /dev/sdd

#### Мониторинг восстановления
Просмотрите процесс восстановления:
cat /proc/mdstat

---

### 10. Диагностика и устранение неисправностей

#### Проверка состояния дисков
Проверьте состояние дисков с помощью `smartctl`:
smartctl -a /dev/sdb

#### Распространенные проблемы:
- Сбой одного или нескольких дисков.
- Неправильная конфигурация RAID.
- Отсутствие резервных дисков.

---

### 11. Безопасность RAID

#### Резервное копирование
Регулярно создавайте резервные копии данных, даже если используется RAID.

#### Мониторинг
Настройте мониторинг состояния RAID-массива:
mdadm --monitor --scan --daemonise

---

### 12. Пример создания RAID-массива

#### Шаги:
1. Выведите список дисков:
   lsblk
2. Подготовьте диски:
   dd if=/dev/zero of=/dev/sdb bs=1M count=100
   dd if=/dev/zero of=/dev/sdc bs=1M count=100
3. Создайте RAID 1:
   mdadm --create --verbose /dev/md0 --level=1 --raid-devices=2 /dev/sdb /dev/sdc
4. Создайте файловую систему:
   mkfs.ext4 /dev/md0
5. Монтируйте RAID-массив:
   mkdir /mnt/raid
   mount /dev/md0 /mnt/raid
6. Настройте автоматическое монтирование:
   echo "/dev/md0 /mnt/raid ext4 defaults 0 0" >> /etc/fstab
7. Проверьте статус:
   cat /proc/mdstat

---

## Домашнее задание
1. Выведите список дисков на вашей системе.
2. Подготовьте два диска для создания RAID-массива.
3. Создайте RAID 1 (зеркало) из двух дисков.
4. Монтируйте RAID-массив и проверьте его работу.
5. Замените один из дисков на новый и проверьте процесс восстановления.
6. Исследуйте возможности аппаратного RAID и BBU.

---

## Вопросы для самопроверки
1. Что такое RAID и для чего он используется?
2. Какие уровни RAID существуют и чем они отличаются?
3. Как вывести список дисков в Linux?
4. Как подготовить диски перед добавлением в RAID?
5. Как смонтировать RAID-массив и настроить его автоматическое монтирование?
6. Что такое BBU и какую роль он играет в аппаратном RAID?
7. Что такое HotSwap и HotSpare?
8. Как восстановить данные в случае сбоя диска?
9. Какие меры безопасности можно применить для защиты данных в RAID?
