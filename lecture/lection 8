# Лекция 8: Протокол DHCP

## Цели и задачи
- Изучить основные принципы работы протокола DHCP.
- Разобраться с ролью DHCP в автоматической настройке сетевых параметров.
- Научиться устанавливать и настраивать DHCP-сервер в Linux.
- Понять процесс диагностики и устранения неисправностей в работе DHCP.
- Изучить взаимодействие DHCP и DNS (BIND).

---

## Основной материал

### 1. Введение в протокол DHCP

#### Что такое DHCP?
DHCP (Dynamic Host Configuration Protocol) — это сетевой протокол, который автоматически назначает IP-адреса и другие сетевые параметры устройствам в локальной сети. Это позволяет упростить управление сетью и избежать ручной настройки каждого устройства.

#### Зачем нужен DHCP?
- Автоматическое назначение IP-адресов устройствам.
- Упрощение управления сетью.
- Предотвращение конфликтов IP-адресов.
- Централизованное управление сетевыми параметрами.

#### Как работает DHCP?
1. Клиент отправляет запрос (DHCP Discover):
   - Устройство, подключившись к сети, отправляет широковещательный запрос для поиска DHCP-сервера.
2. Сервер отвечает предложением (DHCP Offer):
   - DHCP-сервер предлагает клиенту IP-адрес и другие параметры.
3. Клиент запрашивает адрес (DHCP Request):
   - Клиент выбирает предложенный адрес и отправляет запрос на его использование.
4. Сервер подтверждает назначение (DHCP Acknowledge):
   - Сервер подтверждает назначение IP-адреса и предоставляет дополнительные параметры (например, маску подсети, шлюз, DNS).

---

### 2. Сетевые параметры, предоставляемые DHCP

DHCP-сервер может предоставлять следующие параметры:
- IP-адрес: Уникальный адрес устройства в сети.
- Маска подсети: Определяет размер локальной сети.
- Шлюз по умолчанию: Адрес маршрутизатора для выхода в интернет.
- DNS-серверы: Адреса серверов для разрешения доменных имен.
- Время аренды (Lease Time): Период, в течение которого IP-адрес остается закрепленным за устройством.

---

### 3. Установка и настройка DHCP-сервера

#### Установка DHCP-сервера
Для установки DHCP-сервера в Linux используется пакет isc-dhcp-server.

##### Шаги:
1. Установите пакет:
   apt install isc-dhcp-server
2. Настройте конфигурационный файл:
   /etc/dhcp/dhcpd.conf

##### Пример конфигурации:
subnet 192.168.1.0 netmask 255.255.255.0 {
  range 192.168.1.100 192.168.1.200;
  option routers 192.168.1.1;
  option domain-name-servers 8.8.8.8, 8.8.4.4;
  default-lease-time 600;
  max-lease-time 7200;
}
- subnet: Определяет подсеть.
- range: Диапазон IP-адресов для назначения.
- routers: Шлюз по умолчанию.
- domain-name-servers: DNS-серверы.
- default-lease-time: Время аренды по умолчанию (в секундах).
- max-lease-time: Максимальное время аренды.

#### Запуск службы
1. Запустите службу:
   systemctl start isc-dhcp-server
2. Добавьте службу в автозагрузку:
   systemctl enable isc-dhcp-server

---

### 4. Диагностика и устранение неисправностей

#### Проверка работы DHCP
1. Проверьте статус службы:
   systemctl status isc-dhcp-server
2. Просмотрите логи:
   journalctl -u isc-dhcp-server

#### Тестирование клиента
1. Выполните запрос DHCP на клиенте:
   dhclient eth0
2. Проверьте полученные параметры:
   ip addr show eth0

#### Распространенные проблемы:
- Конфликты IP-адресов: Убедитесь, что диапазон адресов в конфигурации не пересекается с другими устройствами.
- Недоступность сервера: Проверьте, что DHCP-сервер запущен и доступен в сети.
- Ошибки конфигурации: Проверьте синтаксис файла /etc/dhcp/dhcpd.conf.

---

### 5. Безопасность DHCP

#### Защита DHCP-сервера
1. Ограничение доступа:
   - Разрешите только доверенные устройства получать IP-адреса.
   - Используйте MAC-фильтрацию для привязки адресов к устройствам.
2. Защита от атак:
   - Предотвращайте атаки типа "DHCP Spoofing" с помощью инструментов, таких как DHCP Snooping.

---

### 6. Связь BIND и DHCP

#### Зачем связывать DHCP и DNS?
DHCP-сервер может взаимодействовать с DNS-сервером (например, BIND), чтобы автоматически регистрировать хосты в DNS. Это полезно для:
- Автоматического обновления записей A и PTR в DNS.
- Упрощения управления большими сетями, где устройства часто меняют IP-адреса.

#### Как работает связь?
1. DHCP-сервер отправляет данные в DNS:
   - Когда устройство получает IP-адрес, DHCP-сервер отправляет информацию о нем в DNS-сервер.
   - DNS-сервер создает или обновляет записи A (имя -> IP) и PTR (IP -> имя).

2. Настройка в DHCP:
   В конфигурации DHCP-сервера добавьте параметры для взаимодействия с DNS:
   ddns-update-style interim;
   option domain-name "example.com";
   option domain-name-servers 192.168.1.10;
   - ddns-update-style interim: Включает динамическое обновление DNS.
   - option domain-name: Указывает домен для регистрации хостов.
   - option domain-name-servers: Указывает DNS-сервер.

3. Настройка в BIND:
   В конфигурации DNS-сервера (BIND) разрешите динамические обновления:
   zone "example.com" {
       type master;
       file "/etc/bind/db.example.com";
       allow-update { key dhcp-key; };
   };
   - allow-update: Разрешает обновление зоны с использованием ключа безопасности.

#### Подробнее про DHCP-ключ

##### Зачем нужен DHCP-ключ?
DHCP-ключ (TSIG — Transaction Signature) обеспечивает безопасное взаимодействие между DHCP-сервером и DNS-сервером. Без ключа любой злоумышленник мог бы отправить фальшивые запросы на обновление DNS-записей, что привело бы к компрометации DNS.

##### Как работает DHCP-ключ?
1. Генерация ключа:
   - Ключ создается с помощью утилиты dnssec-keygen.
   - Он состоит из двух частей: открытого и закрытого ключей.
2. Настройка DNS-сервера (BIND):
   - Ключ добавляется в конфигурацию BIND, чтобы разрешить обновления зон только от доверенных источников.
3. Настройка DHCP-сервера:
   - Ключ добавляется в конфигурацию DHCP-сервера, чтобы он мог аутентифицироваться на DNS-сервере.

##### Шаги для настройки DHCP-ключа

1. Генерация ключа:
   dnssec-keygen -a HMAC-MD5 -b 128 -n USER dhcp-key

   Результат:
   Kdhcp-key.+157+12345.key
   Kdhcp-key.+157+12345.private

2. Создание файла ключа для BIND:
   /etc/bind/dhcp-key.conf

   Содержимое:
   key "dhcp-key" {
       algorithm hmac-md5;
       secret "ABCDEF1234567890";
   };

3. Настройка BIND:
   include "/etc/bind/dhcp-key.conf";

   zone "example.com" {
       type master;
       file "/etc/bind/db.example.com";
       allow-update { key "dhcp-key"; };
   };

   zone 1.168.192.in-addr.arpa {
       type master;
       file "/etc/bind/db.192.168.1";
       allow-update { key "dhcp-key"; };
   };

4. Настройка DHCP:
   key "dhcp-key" {
       algorithm hmac-md5;
       secret "ABCDEF1234567890";
   };

   zone example.com {
       primary 192.168.1.10;
       key "dhcp-key";
   }

   zone 1.168.192.in-addr.arpa {
       primary 192.168.1.10;
       key "dhcp-key";
   }

5. Перезапустите службы:
   systemctl restart isc-dhcp-server
   systemctl restart bind9

##### Пример работы с DHCP-ключом
- Подключите устройство к сети.
- Проверьте, что запись A (имя -> IP) и PTR (IP -> имя) автоматически добавлены в DNS.

---

## Домашнее задание
1. Установите и настройте DHCP-сервер на виртуальной машине.
2. Настройте диапазон IP-адресов и проверьте работу DHCP на клиенте.
3. Изучите логи DHCP-сервера и найдите записи о выданных адресах.
4. Настройте связь DHCP с DNS-сервером (BIND) для автоматической регистрации хостов.
5. Проверьте, что записи A и PTR создаются корректно.

---

## Вопросы для самопроверки
1. Что такое DHCP и для чего он используется?
2. Какие параметры предоставляет DHCP-сервер?
3. Как установить и настроить DHCP-сервер в Linux?
4. Как проверить работу DHCP на клиенте?
5. Какие меры безопасности можно применить для защиты DHCP-сервера?
6. Как настроить связь между DHCP и DNS (BIND)?
7. Для чего используется DHCP-ключ? Как его настроить?
