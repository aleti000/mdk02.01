# Лекция 28: Настройка Grafana

## Цели и задачи
- Изучить основные принципы работы Grafana как инструмента визуализации данных.
- Разобраться с архитектурой Grafana и её компонентами (панели, дашборды, источники данных).
- Научиться устанавливать и настраивать Grafana для визуализации метрик.
- Понять процесс создания дашбордов и настройки оповещений.
- Изучить диагностику и устранение неисправностей в работе Grafana.

---

## Основной материал

### 1. Введение в Grafana

#### Что такое Grafana?
Grafana — это платформа с открытым исходным кодом для визуализации данных. Она позволяет создавать интерактивные графики, дашборды и панели мониторинга на основе данных из различных источников (Prometheus, InfluxDB, Elasticsearch и т.д.).

#### Зачем нужен Grafana?
- Визуализация метрик в реальном времени.
- Создание дашбордов для анализа данных.
- Интеграция с системами оповещений (например, Alertmanager).

#### Основные компоненты:
1. Дашборды: Содержат панели для отображения данных.
2. Панели: Отдельные элементы дашборда (графики, таблицы, индикаторы).
3. Источники данных: Системы, предоставляющие данные (Prometheus, MySQL, PostgreSQL и т.д.).
4. Оповещения: Уведомления о событиях на основе правил.

---

### 2. Установка Grafana

#### Используемые пакеты
Для установки Grafana используется пакетный менеджер. Например, в Ubuntu:

1. Добавьте репозиторий Grafana:
   wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
   echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee /etc/apt/sources.list.d/grafana.list
2. Обновите список пакетов:
   apt update
3. Установите Grafana:
   apt install grafana

#### Запуск службы
Запустите службу Grafana:
systemctl start grafana-server
systemctl enable grafana-server

---

### 3. Настройка источников данных

#### Добавление Prometheus
1. Откройте веб-интерфейс Grafana:
   http://localhost:3000
2. Перейдите в раздел Configuration -> Data Sources.
3. Нажмите Add data source и выберите Prometheus.
4. Укажите URL Prometheus:
   http://localhost:9090
5. Нажмите Save & Test.

---

### 4. Создание дашбордов

#### Добавление панели
1. Перейдите в раздел Create -> Dashboard.
2. Нажмите Add new panel.
3. Выберите источник данных (например, Prometheus).
4. Укажите запрос PromQL:
   rate(http_requests_total[5m])
5. Настройте визуализацию (например, график или таблица).

#### Сохранение дашборда
1. Нажмите Save dashboard.
2. Укажите имя дашборда и сохраните его.

---

### 5. Настройка оповещений

#### Создание правила
1. Перейдите в раздел Alerting -> Alert Rules.
2. Нажмите Create Alert Rule.
3. Укажите условие для оповещения:
   avg(rate(http_requests_total[5m])) > 100
4. Настройте канал оповещения (например, email или Slack).

#### Настройка каналов оповещений
1. Перейдите в раздел Alerting -> Notification channels.
2. Нажмите Add channel.
3. Выберите тип канала (например, email) и укажите параметры:
   SMTP Host: smtp.example.com:587
   From: grafana@example.com
   To: admin@example.com

---

### 6. Импорт готовых дашбордов

#### Импорт JSON-файла
1. Скачайте JSON-файл дашборда (например, с сайта Grafana Labs).
2. Перейдите в раздел Create -> Import.
3. Загрузите JSON-файл или введите его ID.
4. Выберите источник данных и импортируйте дашборд.

---

### 7. Диагностика и устранение неисправностей

#### Просмотр логов
Логи Grafana находятся в каталоге:
/var/log/grafana/

#### Распространенные проблемы:
- Неправильная настройка источника данных.
- Проблемы с доступом к базе данных Grafana.
- Ошибки в запросах PromQL.

---

### 8. Безопасность Grafana

#### Ограничение доступа
Ограничьте доступ к Grafana через файрвол:
ufw allow from 192.168.1.0/24 to any port 3000

#### Настройка аутентификации
1. Включите аутентификацию через LDAP:
   [auth.ldap]
   enabled = true
   config_file = /etc/grafana/ldap.toml
2. Настройте права доступа для пользователей.

---

### 9. Пример настройки Grafana

#### Шаги:
1. Установите Grafana:
   apt install grafana
2. Запустите службу:
   systemctl start grafana-server
3. Добавьте Prometheus как источник данных:
   http://localhost:9090
4. Создайте дашборд с графиком:
   rate(http_requests_total[5m])
5. Настройте оповещения для высокой нагрузки.

---

## Домашнее задание
1. Установите и настройте Grafana на виртуальной машине.
2. Добавьте Prometheus как источник данных.
3. Создайте дашборд с графиком CPU и RAM.
4. Настройте оповещения для высокой нагрузки CPU.
5. Импортируйте готовый дашборд из JSON-файла.

---

## Вопросы для самопроверки
1. Что такое Grafana и для чего он используется?
2. Как установить и настроить Grafana?
3. Как добавить источник данных в Grafana?
4. Как создать дашборд и настроить оповещения?
5. Какие меры безопасности можно применить для защиты Grafana?
