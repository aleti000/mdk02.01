# Лабораторное занятие №1: Настройка инфраструктуры сети

## Тема
Настройка сетевой инфраструктуры с использованием различных инструментов управления сетью

## Цель
Освоить настройку сетевых интерфейсов, маршрутизации и правил трансляции сетевых адресов (NAT) для организации доступа к сети Интернет

## Схема сети
**ссылка на схему сети**

![alt text](https://github.com/aleti000/mdk02.01/blob/main/pic/network02.jpg)

## Теоретические основы

### Сетевые инструменты Linux

В лабораторной работе используются два основных инструмента для управления сетевыми настройками:

#### 1. Etcnet (системный менеджер сети)
- **Файлы конфигурации**: `/etc/net/ifaces/<интерфейс>/`
- **Основные файлы**:
  - `options` - основные параметры интерфейса
  - `ipv4address` - IP-адрес и маска сети
  - `ipv4route` - маршрут по умолчанию
  - `resolv.conf` - DNS-серверы

#### 2. NetworkManager
- **Графический интерфейс**: nm-connection-editor
- **Командная строка**: утилита `nmcli`
- **Конфигурационные файлы**: `/etc/NetworkManager/system-connections/`

### Параметры сетевых интерфейсов

| Параметр | Значение | Описание |
|----------|----------|----------|
| `BOOTPROTO` | `dhcp` | Получение IP-адреса от DHCP-сервера |
| `BOOTPROTO` | `static` | Статическая настройка IP-адреса |
| `TYPE` | `eth` | Тип интерфейса (Ethernet) |
| `NM_CONTROLLED` | `yes/no` | Управление через NetworkManager |
| `ONBOOT` | `yes/no` | Активация при загрузке системы |

### Диагностика сети

Перед выполнением лабораторной работы рекомендуется проверить текущее состояние сети:

```bash
# Проверка сетевых интерфейсов
ip addr show

# Проверка маршрутизации
ip route show

# Проверка доступности сети
ping -c 3 8.8.8.8

# Проверка разрешения имен
nslookup google.com
```

## Методические указания

### Подготовка к выполнению работы

1. **Изучите теоретический материал** о настройке сети в Linux
2. **Подготовьте схему сети** согласно заданию
3. **Определите IP-адреса** для всех устройств сети
4. **Выберите инструмент настройки** (etcnet или NetworkManager)

### Рекомендации по выполнению

#### При использовании etcnet:
- Создавайте резервные копии конфигурационных файлов
- Проверяйте синтаксис файлов после редактирования
- Используйте команды `ip addr` для проверки настроек

#### При использовании NetworkManager:
- Используйте табуляцию для автодополнения команд
- Проверяйте статус соединений командой `nmcli connection show`
- Сохраняйте UUID соединений для быстрого управления

### Возможные проблемы и решения

| Проблема | Возможное решение |
|----------|-------------------|
| Интерфейс не поднимается | Проверить файл options на ошибки синтаксиса |
| Нет доступа в интернет | Проверить маршрут по умолчанию и настройки NAT |
| DNS не работает | Проверить файл resolv.conf |
| NetworkManager конфликтует | Отключить управление в etcnet (`NM_CONTROLLED=no`) |

## Ход работы

### Настройка сети

#### Настройка устройства gateway

1. **Настроим интерфейс в сторону CLI-office:**
   ```bash
   cp -R /etc/net/ifaces/ens18 /etc/net/ifaces/ens19
   echo "TYPE=eth" > /etc/net/ifaces/ens19/options
   echo "BOOTPROTO=static" >> /etc/net/ifaces/ens19/options
   echo "192.168.0.1/24" > /etc/net/ifaces/ens19/ipv4address
   ```

2. **Настроим интерфейс в сторону internet:**
   ```bash
   cp -R /etc/net/ifaces/ens18 /etc/net/ifaces/ens20
   ```

3. **Настроим интерфейс в сторону сети office:**
   ```bash
   cp -R /etc/net/ifaces/ens18 /etc/net/ifaces/ens21
   echo "TYPE=eth" > /etc/net/ifaces/ens21/options
   echo "BOOTPROTO=static" >> /etc/net/ifaces/ens21/options
   echo "172.16.0.1/24" > /etc/net/ifaces/ens21/ipv4address
   ```

4. **Перезагрузим сеть:**
   ```bash
   systemctl restart network
   ```

5. **Проверим параметры сети:**
   ```bash
   ip -br -c a
   ```

### Настройка выхода в интернет

**Настроим возможность выхода устройств сети в интернет используя gateway как шлюз:**

1. Обновим пакеты:
   ```bash
   apt-get update
   apt-get install iptables
   ```

2. Настроим NAT:
   ```bash
   iptables -t nat -A POSTROUTING -o ens20 -j MASQUERADE
   ```

3. Сохраним таблицу iptables:
   ```bash
   iptables-save > /etc/sysconfig/iptables
   ```

4. Включим IP forwarding в файле `/etc/net/sysctl.conf`:
   ```bash
   # Найти строку net.ipv4.ip_forward = 0 и заменить 0 на 1
   sed -i 's/net.ipv4.ip_forward = 0/net.ipv4.ip_forward = 1/' /etc/sysconfig/sysctl.conf
   ```

5. Перезапустим систему:
   ```bash
   reboot
   ```

## Задание

**Назначить IP-адреса устройствам сети:**

1. **CLI-home** - любой статический IP-адрес сети home. Настройку производить через NetworkManager (с помощью графического режима или nmcli)
2. **SRV1** - статический адрес из подсети office `192.168.0.2/24`, не забудьте назначить шлюз и DNS
3. **SRV2** - будет получать статический IP-адрес через DHCP-сервер на SRV1
4. **CLI-office** - получает любой свободный адрес из пула адресов office

**Критерии выполнения работы:**
Работа считается выполненной если SRV1 и CLI-office могут пинговать интернет-адреса по именам (доменные имена успешно разрешаются в IP-адреса).

## Требования к отчету

Отчет должен содержать:

1. **Описание выполненных действий** - подробное описание всех команд и настроек
2. **Скриншоты конфигурации** - изображения настроек сетевых интерфейсов
3. **Результаты тестирования** - вывод команд проверки сети (ip addr, ping, etc.)
4. **Пояснения** - объяснение принципов работы NAT и маршрутизации
5. **Возможные проблемы и решения** - описание возникших трудностей и способов их решения

## Полезные команды для диагностики

```bash
# Проверка сетевых интерфейсов
ip addr show

# Проверка маршрутизации
ip route show

# Проверка доступности хоста
ping -c 4 8.8.8.8
ping -c 4 google.com

# Проверка разрешения имен
nslookup google.com

# Проверка правил iptables
iptables -t nat -L -v

# Проверка статуса NetworkManager
nmcli general status
nmcli connection show
```
