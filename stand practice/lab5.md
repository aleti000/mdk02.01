# Лабораторное занятие №5: Работа с групповыми политиками

## Тема
Работа с групповыми политиками

## Цель
Освоить процесс настройки групповых политик (GPO) для клиентов Alt Linux в домене Samba AD, включая развертывание инфраструктуры групповых политик, создание объектов групповых политик и их назначение на пользователей и компьютеры

## Схема сети

![alt text](https://github.com/aleti000/mdk02.01/blob/main/pic/network02.jpg)

## Теоретические основы

### Групповые политики Active Directory

Групповые политики — это набор правил и настроек для серверов и рабочих станций, реализуемых в корпоративных решениях. В соответствии с групповыми политиками производится настройка рабочей среды относительно локальных политик, действующих по умолчанию. В данном разделе рассмотрена реализация поддержки групповых политик Active Directory в решениях на базе дистрибутивов ALT.

В дистрибутивах ALT для применения групповых политик предлагается использовать инструмент `gpupdate`. Инструмент рассчитан на работу на машине, введённой в домен Samba.

#### Принципы работы групповых политик

Интеграция в инфраструктуру LDAP-объектов Active Directory позволяет осуществлять привязку настроек управляемых конфигураций объектам в дереве каталогов. Кроме глобальных настроек в рамках домена возможна привязка к следующим группам объектов:
- **подразделения (OU)** — пользователи и компьютеры, хранящиеся в соответствующей части дерева объектов;
- **сайты** — группы компьютеров в заданной подсети в рамках одного и того же домена;
- **конкретные пользователи и компьютеры**.

Кроме того, в самих объектах групповых политик могут быть заданы дополнительные условия, фильтры и ограничения, на основании которых принимается решение о том, как применять данную групповую политику.

#### Политики для компьютеров и пользователей

Политики подразделяются на политики для компьютеров (Machine) и политики для пользователей (User). Политики для компьютеров применяются на хосте в момент загрузки и в момент явного или регулярного запроса планировщиком (раз в час). Пользовательские политики применяются в момент входа в систему.

Групповые политики можно использовать для разных целей, например:
- управления интернет-браузерами Firefox/Chromium/Yandex;
- управления почтовым клиентом Mozilla Thunderbird;
- установки запрета на подключение внешних носителей;
- управления политиками control;
- включения или выключения различных служб (сервисов systemd);
- настройки удалённого доступа к рабочему столу (VNC) и настройки графической среды Mate;
- настройки среды рабочего стола KDE (экспериментальная политика);
- управления настройками службы Polkit;
- подключения сетевых дисков;
- управления переменными среды;
- генерации (удаления/замены) ярлыков для запуска программ;
- управления файлами (экспериментальная политика);
- управления сценариями запуска и завершения работы компьютера, входа и выхода пользователя из системы (экспериментальная политика);
- установки и удаления пакетов (экспериментальная политика).

### Инфраструктура групповых политик в Samba AD

Для работы групповых политик необходим контроллер домена Samba с встроенным DNS. Дополнительные компоненты:
- **gpupdate** — утилита для применения политик;
- **samba-tool gpo** — инструменты для управления GPO;
- **ADMX-файлы** — административные шаблоны.

## Методические указания

### Подготовка к выполнению работы

1. **Изучите теоретический материал** о групповых политиках Active Directory
2. **Проверьте сетевые настройки** согласно лабораторной работе №1
3. **Убедитесь в готовности домена Samba AD** согласно лабораторной работе №4

### Рекомендации по выполнению

#### При настройке групповых политик:
- Убедитесь, что клиент присоединён к домену SSSD или Winbind
- Установите необходимые пакеты для работы GPO
- Проверьте права доступа к каталогам sysvol и PolicyDefinitions
- Используйте графические инструменты для создания политик (GPUI) или командную строку

#### При создании и применении политик:
- Тестируйте политики сначала на тестовых пользователях/компьютерах
- Документируйте изменения, вносимые политиками
- Проверяйте логи применения политик (journalctl -u gpupdate)

#### Безопасность:
- Разграничивайте права на чтение и модификацию GPO
- Используйте GPAC (Group Policy Access Control) для контроля доступа
- Регулярно проверяйте корректность применения политик

### Возможные проблемы и решения

| Проблема | Возможное решение |
|----------|-------------------|
| gpupdate не применяется | Проверить принадлежность к домену, статус служб SSSD/Winbind |
| ADMX-файлы не загружены | Выполнить samba-tool gpo admxload, проверить sysvol |
| Политики не применяются | Проверить права доступа к OU, корректность GPO |
| Ошибки в логах gpupdate | Проверить конфигурацию SSSD, синхронизацию времени |

## Ход работы

### Часть 1: Подготовка инфраструктуры групповых политик

#### Шаг 1. Настройка контроллера домена для групповых политик

**На SRV1:**
```bash
# Обновить систему и установить необходимые пакеты
apt-get update
apt-get install admx-basealt admx-chromium admx-firefox admx-yandex-browser admx-thunderbird admx-msi-setup

# Запустить службу Samba, если она не запущена
systemctl status samba

# Проверить домен
samba-tool domain info
```

#### Шаг 2. Загрузка административных шаблонов

**На SRV1:**
```bash
# Загрузить ADMX-файлы Microsoft в sysvol
samba-tool gpo admxload -U administrator

# Проверить наличие шаблонов в каталоге
ls -la /var/lib/samba/sysvol/TEST.SA/Policies/PolicyDefinitions/
```

### Часть 2: Присоединение клиента к домену и настройка GPO

#### Шаг 3. Присоединение CLI-office к домену с поддержкой GPO

**На CLI-office:**
```bash
# Обновить систему и установить пакеты для домена и GPO
apt-get update
apt-get install task-auth-ad-sssd realmd krb5-workstation alterator-gpupdate gpui

# Настроить DNS для разрешения домена
echo "nameserver 172.16.0.2" > /etc/resolv.conf
echo "search test.sa" >> /etc/resolv.conf

# Присоединиться к домену с включением групповых политик
realm join --user=administrator test.sa

# Ввести пароль: P@ssw0rd

# Перезагрузить систему
reboot
```

**После перезагрузки на CLI-office:**
```bash
# Проверить членство в домене
realm list

# Проверить статус gpupdate
systemctl status gpupdate

# Запустить apply gpupdate вручную для проверки
gpupdate --force
```

#### Шаг 4. Создание групповой политики

**На SRV1 или CLI-office (с GPUI):**
```bash
# Запустить графический интерфейс для управления GPO (если установлена среда рабочего стола)
gpui &
```

**Или с помощью командной строки на SRV1:**
```bash
# Создать новый объект групповой политики
samba-tool gpo create "TestPolicy" -U administrator

# Получить список GPO
samba-tool gpo listall

# Назначить GPO на OU или домен (например, на домен по умолчанию)
samba-tool gpo setlink "CN=Policies,CN=System,DC=test,DC=alt" "CN={GUID}," -U administrator
# Где {GUID} - GUID созданной политики из предыдущего шага
```

### Часть 3: Настройка и применение политик

#### Шаг 5. Настройка политики ограничения доступа к ping

**С помощью GPUI:**

1. Открыть GPUI
2. Выбрать политику "TestPolicy"
3. Перейти к Конфигурация компьютера → Административные шаблоны → Система ALT → Сетевые приложения
4. Включить политику "Разрешения для /usr/bin/ping" и установить "Только root"

**Или с помощью командной строки на SRV1:**
```bash
# Использовать samba-tool для управления настройками (требует дополнительных инструментов)
# Для простоты используем прямое редактирование файлов GPO в sysvol
```

#### Шаг 6. Применение политики на клиенте

**На CLI-office:**
```bash
# Обновить политики
gpupdate --force

# Проверить применение политики
journalctl -u gpupdate -n 20

# Тестировать доступ к ping для обычного пользователя
su - testuser  # войти под обычным пользователем
ping -c 1 localhost  # должно быть отказано в доступе

# Проверить как root
ping -c 1 localhost  # должно работать
```

### Часть 4: Создание организационной структуры и привязка политик

#### Шаг 7. Создание OU и перемещение клиентов

**На SRV1:**
```bash
# Создать OU для рабочих станций
samba-tool ou create "OU=Workstations,DC=test,DC=alt" -U administrator

# Переместить компьютер CLI-office в OU
samba-tool computer move "CN=CLI-OFFICE,CN=Computers,DC=test,DC=alt" "OU=Workstations,DC=test,DC=alt" -U administrator
```

#### Шаг 8. Привязка GPO к OU

**На SRV1:**
```bash
# Получить GUID политики
samba-tool gpo listall

# Привязать политику к OU
samba-tool ou gpolink "OU=Workstations,DC=test,DC=alt" "CN={GUID},CN=Policies,CN=System,DC=test,DC=alt" -U administrator
```

#### Шаг 9. Проверка применения политик

**На CLI-office:**
```bash
# Вызвать обновление политик
gpupdate

# Проверить логи
journalctl -u gpupdate

# Проверить результат
id  # проверить, что пользователь в домене
ping google.com  # проверить политику ping (как обычный пользователь)
```

## Задание

**Настройка групповых политик для домена test.sa:**

1. **SRV1** — настроить инфраструктуру групповых политик (загрузить ADMX-шаблоны)
2. **CLI-office** — присоединить клиентскую машину к домену с поддержкой GPO
3. **Создать GPO** — политику ограничения доступа к команде ping (только root)
4. **Связать GPO** с OU, содержащим рабочие станции
5. **Протестировать применение** политики на клиенте

**Критерии выполнения работы:**
Работа считается выполненной если:
- Инфраструктура GPO настроена на контроллере домена
- Клиент CLI-office успешно присоединён к домену и получает политики
- Создана GPO с ограничением доступа к ping
- Политика правильно применяется: обычные пользователи не могут выполнять ping, root может
- Логи gpupdate показывают успешное применение политик

## Критерии выполнения работы

Работа считается выполненной если:

1. **ADMX-шаблоны загружены** на контроллер домена
2. **Клиент присоединён к домену** с поддержкой групповых политик
3. **GPO создана и настроена** для ограничения доступа к ping
4. **Политика применяется корректно** на клиентской машине
5. **Логи подтверждают** успешное применение GPO

## Возможные проблемы и решения

| Проблема | Возможное решение |
|----------|-------------------|
| gpupdate service not found | Установить пакет alterator-gpupdate |
| ADMX templates not loaded | Выполнить samba-tool gpo admxload |
| Policy doesn't apply | Проверить членство в домене, перезагрузить клиента |
| Permission denied | Проверить права доступа к sysvol, DNS |
| GPUI not starting | Установить пакеты для GUI, проверить DISPLAY |

## Полезные команды для диагностики

```bash
# Проверка статуса служб
systemctl status samba sssd gpupdate

# Диагностика домена
samba-tool domain info
realm list

# Управление GPO
samba-tool gpo listall
samba-tool ou gpolink --list "OU=Workstations,DC=test,DC=alt"

# Применение политик
gpupdate --force
gpupdate --loglevel 0

# Просмотр логов
journalctl -u gpupdate
journalctl -u sssd

# Проверка sysvol
ls -la /var/lib/samba/sysvol/TEST.SA/Policies/

# Проверка разрешений
id <username>@TEST.SA
groups <username>@TEST.SA
