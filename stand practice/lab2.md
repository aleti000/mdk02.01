# Лабораторное занятие №2: Настройка SSH для доступа к серверам

## Тема
Настройка безопасного удаленного доступа к серверам с использованием SSH-протокола

## Цель
Освоить настройку SSH-сервера и клиента, генерацию и использование SSH-ключей, конфигурирование параметров безопасности SSH-соединений

## Теоретические сведения

### Основы SSH (Secure Shell)

SSH (Secure Shell) - это криптографический сетевой протокол для безопасного удаленного доступа к компьютерам через незащищенные сети. SSH обеспечивает:

- **Шифрование трафика** между клиентом и сервером
- **Аутентификацию** с использованием ключей или паролей
- **Целостность данных** через контрольные суммы
- **Сжатие трафика** для повышения производительности

### Компоненты SSH

#### SSH-сервер (sshd)
- Прослушивает входящие соединения на порту 22 (по умолчанию)
- Аутентифицирует клиентов
- Выполняет команды или предоставляет shell-доступ

#### SSH-клиент (ssh)
- Инициирует соединения с SSH-серверами
- Поддерживает различные методы аутентификации
- Позволяет настраивать параметры соединения

### Методы аутентификации SSH

1. **Парольная аутентификация** - использование логина/пароля
2. **Аутентификация по ключам** - использование пары ключей (приватный/публичный)
3. **Аутентификация по сертификатам** - использование цифровых сертификатов

### Структура SSH-ключей

- **Приватный ключ** (`id_rsa`) - хранится на клиенте, должен быть защищен
- **Публичный ключ** (`id_rsa.pub`) - размещается на сервере в файле `~/.ssh/authorized_keys`

## Схема сети

![alt text](https://github.com/aleti000/mdk02.01/blob/main/pic/network02.jpg)

**Описание сети:**
- **CLI-home** - клиентская машина в домашней сети (192.168.0.0/24)
- **CLI-office** - клиентская машина в офисной сети (172.16.0.0/24)
- **SRV1** - сервер в офисной сети (172.16.0.2)
- **SRV2** - сервер в офисной сети (172.16.0.3)

## Методические указания

### Подготовка к выполнению работы

1. **Изучите теоретический материал** о настройке SSH в Linux
2. **Подготовьте схему сети** согласно заданию
3. **Определите параметры доступа** для всех устройств сети
4. **Выберите метод аутентификации** (ключи или пароли)

### Рекомендации по выполнению

#### Генерация SSH-ключей:
```bash
# Генерация пары ключей RSA (4096 бит)
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -C "комментарий"

# Генерация пары ключей Ed25519 (более современный алгоритм)
ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -C "комментарий"
```

#### Управление SSH-ключами:
```bash
# Копирование публичного ключа на сервер
ssh-copy-id -i ~/.ssh/id_rsa.pub пользователь@сервер

# Проверка отпечатка ключа сервера
ssh-keyscan -H сервер >> ~/.ssh/known_hosts
```

#### Диагностика SSH-соединений:
```bash
# Проверка синтаксиса конфигурации SSH-сервера
sshd -t

# Проверка статуса SSH-сервера
systemctl status sshd

# Просмотр активных SSH-соединений
ss -tuln | grep :22
```

## Ход работы

### Часть 1: Подготовка серверов (SRV1 - с инструкцией, SRV2 - самостоятельно)

#### Шаг 1. Создание пользователя для удаленного доступа

**На SRV1 (с подробной инструкцией):**
```bash
# Создать пользователя remoteadm
sudo useradd -m -s /bin/bash remoteadm

# Добавить пользователя в группу wheel для sudo-доступа
sudo usermod -aG wheel remoteadm

# Создать пароль для пользователя
sudo passwd remoteadm

# Настроить sudo-доступ (отредактировать /etc/sudoers)
echo 'remoteadm ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/remoteadm
```

**На SRV2 (самостоятельно):**
```bash
# Повторите те же команды для создания пользователя remoteadm
# Используйте тот же пароль или создайте новый
sudo useradd -m -s /bin/bash remoteadm
sudo usermod -aG wheel remoteadm
sudo passwd remoteadm
echo 'remoteadm ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/remoteadm
```

#### Шаг 2. Настройка SSH-сервера

**На SRV1 (с подробной инструкцией):**

Создайте резервную копию оригинального конфигурационного файла:
```bash
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
```

Отредактируйте файл `/etc/ssh/sshd_config`:
```bash
# Изменить порт SSH на 2243
sudo sed -i 's/#Port 22/Port 2243/' /etc/ssh/sshd_config

# Запретить доступ с паролем для пользователя root
sudo sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# Установить максимальное количество попыток аутентификации
sudo sed -i 's/#MaxAuthTries 6/MaxAuthTries 2/' /etc/ssh/sshd_config

# Запретить пустые пароли
sudo sed -i 's/#PermitEmptyPasswords no/PermitEmptyPasswords no/' /etc/ssh/sshd_config

# Отключить парольную аутентификацию
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# Включить аутентификацию по ключам
sudo sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config

# Настроить баннер
sudo sed -i 's|#Banner none|Banner /etc/ssh/banner.txt|' /etc/ssh/sshd_config
```

Создайте файл баннера:
```bash
sudo tee /etc/ssh/banner.txt > /dev/null << 'EOF'
╔══════════════════════════════════════════════════════════════╗
║                 ДОБРО ПОЖАЛОВАТЬ НА СЕРВЕР!                  ║
║                                                              ║
║  Внимание: Доступ к системе ограничен авторизованными        ║
║  пользователями. Несанкционированный доступ запрещен.       ║
║                                                              ║
║  Все действия регистрируются и могут быть проверены.        ║
╚══════════════════════════════════════════════════════════════╝
EOF
```

**На SRV2 (самостоятельно):**
Повторите настройку SSH-сервера, но используйте другой порт (например, 3344) и создайте собственный баннер.

#### Шаг 3. Создание директории .ssh для пользователя remoteadm

**На SRV1:**
```bash
# Создать директорию .ssh
sudo mkdir -p /home/remoteadm/.ssh

# Установить правильные права доступа
sudo chmod 700 /home/remoteadm/.ssh
sudo chown -R remoteadm:remoteadm /home/remoteadm/.ssh

# Создать файл authorized_keys
sudo touch /home/remoteadm/.ssh/authorized_keys
sudo chmod 600 /home/remoteadm/.ssh/authorized_keys
sudo chown remoteadm:remoteadm /home/remoteadm/.ssh/authorized_keys
```

**На SRV2 (самостоятельно):**
Повторите те же команды для создания директории .ssh.

### Часть 2: Подготовка клиентов (CLI-home - с инструкцией, CLI-office - самостоятельно)

#### Шаг 4. Генерация SSH-ключей

**На CLI-home (с подробной инструкцией):**
```bash
# Создать директорию .ssh если она не существует
mkdir -p ~/.ssh

# Установить правильные права доступа
chmod 700 ~/.ssh

# Сгенерировать пару ключей RSA
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa_srv1 -C "SSH key for SRV1"

# Сгенерировать пару ключей Ed25519 для SRV2
ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519_srv2 -C "SSH key for SRV2"

# Установить правильные права на приватные ключи
chmod 600 ~/.ssh/id_rsa_srv1
chmod 600 ~/.ssh/id_ed25519_srv2
```

**На CLI-office (самостоятельно):**
Сгенерируйте SSH-ключи самостоятельно. Рекомендуется использовать разные ключи для разных серверов.

#### Шаг 5. Копирование публичных ключей на серверы

**На CLI-home (с подробной инструкцией):**
```bash
# Скопировать публичный ключ RSA на SRV1
ssh-copy-id -i ~/.ssh/id_rsa_srv1.pub -p 2243 remoteadm@172.16.0.2

# Скопировать публичный ключ Ed25519 на SRV2
ssh-copy-id -i ~/.ssh/id_ed25519_srv2.pub -p 3344 remoteadm@172.16.0.3

# Добавить ключи серверов в known_hosts
ssh-keyscan -p 2243 172.16.0.2 >> ~/.ssh/known_hosts
ssh-keyscan -p 3344 172.16.0.3 >> ~/.ssh/known_hosts
```

**На CLI-office (самостоятельно):**
Скопируйте ваши публичные ключи на серверы самостоятельно.

#### Шаг 6. Настройка конфигурации SSH-клиента

**На CLI-home (с подробной инструкцией):**
Создайте файл `~/.ssh/config`:
```bash
cat > ~/.ssh/config << 'EOF'
# Настройки для SRV1
Host srv1
    HostName 172.16.0.2
    Port 2243
    User remoteadm
    IdentityFile ~/.ssh/id_rsa_srv1
    StrictHostKeyChecking no
    UserKnownHostsFile ~/.ssh/known_hosts

# Настройки для SRV2
Host srv2
    HostName 172.16.0.3
    Port 3344
    User remoteadm
    IdentityFile ~/.ssh/id_ed25519_srv2
    StrictHostKeyChecking no
    UserKnownHostsFile ~/.ssh/known_hosts

# Глобальные настройки
Host *
    ServerAliveInterval 60
    ServerAliveCountMax 3
    ConnectTimeout 10
EOF

# Установить правильные права на файл конфигурации
chmod 600 ~/.ssh/config
```

**На CLI-office (самостоятельно):**
Создайте файл конфигурации SSH-клиента самостоятельно с настройками для обоих серверов.

### Часть 3: Тестирование подключений

#### Шаг 7. Проверка работоспособности

**На CLI-home (с подробной инструкцией):**
```bash
# Тестирование подключения к SRV1
ssh srv1 "echo 'Подключение к SRV1 успешно' && uptime"

# Тестирование подключения к SRV2
ssh srv2 "echo 'Подключение к SRV2 успешно' && df -h"

# Тестирование sudo-доступа на SRV1
ssh srv1 "sudo systemctl status sshd"

# Проверка отображения баннера при подключении
ssh -v srv1
```

**На CLI-office (самостоятельно):**
Протестируйте подключения к обоим серверам самостоятельно.

## Задание для самостоятельного выполнения

**Для SRV2 и CLI-office:**

1. **Самостоятельно настройте** пользователя remoteadm на SRV2
2. **Самостоятельно настройте** SSH-сервер на SRV2:
   - Выберите порт (отличный от 22 и 2243)
   - Настройте параметры безопасности
   - Создайте собственный баннер
3. **Самостоятельно сгенерируйте** SSH-ключи на CLI-office
4. **Самостоятельно настройте** конфигурацию SSH-клиента на CLI-office
5. **Самостоятельно протестируйте** подключения

## Критерии выполнения работы

Работа считается выполненной если:

1. **На SRV1:** SSH-сервер работает на порту 2243, доступ только по ключам, отображается баннер
2. **На SRV2:** SSH-сервер настроен самостоятельно, доступ только по ключам, отображается баннер
3. **На CLI-home:** Можно подключаться к обоим серверам с использованием коротких имен (srv1, srv2)
4. **На CLI-office:** Можно подключаться к обоим серверам (настройки выполнены самостоятельно)
5. **Безопасность:** Парольная аутентификация отключена на обоих серверах

## Возможные проблемы и решения

| Проблема | Возможное решение |
|----------|-------------------|
| Connection refused | Проверить порт SSH-сервера и firewall |
| Permission denied | Проверить права на файлы ключей и директорию .ssh |
| Host key verification failed | Добавить ключи серверов в known_hosts |
| sudo не работает | Проверить настройки в /etc/sudoers |

## Полезные команды для диагностики

```bash
# Проверка статуса SSH-сервера
sudo systemctl status sshd

# Проверка портов
sudo ss -tuln | grep ssh

# Проверка синтаксиса конфигурации
sudo sshd -t

# Просмотр логов SSH
sudo journalctl -u sshd -f

# Проверка ключей в authorized_keys
cat ~/.ssh/authorized_keys

# Тестирование подключения с verbose-выводом
ssh -v пользователь@сервер
```
