# Лабораторное занятие №3: Настройка DHCP сервера

## Тема
Настройка службы динамического распределения IP-адресов (DHCP) для автоматизации назначения сетевых параметров клиентам

## Цель
Освоить настройку и администрирование DHCP-сервера, научиться создавать конфигурацию для автоматической выдачи IP-адресов, масок подсети, шлюзов по умолчанию и DNS-серверов клиентам сети

## Схема сети

![alt text](https://github.com/aleti000/mdk02.01/blob/main/pic/network02.jpg)

## Теоретические основы

### Основы DHCP (Dynamic Host Configuration Protocol)

DHCP (Dynamic Host Configuration Protocol) - это протокол прикладного уровня модели TCP/IP, предназначенный для автоматического распределения IP-адресов и другой сетевой информации клиентам в сети.

#### Основные компоненты DHCP:

1. **DHCP-сервер** - предоставляет IP-адреса и конфигурационные параметры клиентам
2. **DHCP-клиент** - получает IP-адрес и конфигурацию от сервера
3. **DHCP-reley** - перенаправляет DHCP-запросы между подсетями

#### Процесс работы DHCP:

1. **DHCP Discover** - клиент ищет DHCP-сервер
2. **DHCP Offer** - сервер предлагает IP-адрес
3. **DHCP Request** - клиент запрашивает предложенный адрес
4. **DHCP Acknowledgment** - сервер подтверждает назначение адреса

### Параметры DHCP

| Параметр | Описание |
|----------|----------|
| **IP-адрес** | Уникальный адрес в сети |
| **Маска подсети** | Определяет границы сети |
| **Шлюз по умолчанию** | Маршрут для трафика в другие сети |
| **DNS-серверы** | Серверы для разрешения доменных имен |
| **Время аренды** | Период действия назначенного адреса |

### Конфигурационные файлы DHCP в Linux

Основной конфигурационный файл: `/etc/dhcp/dhcpd.conf`

Структура конфигурации:
```dhcp
# Глобальные параметры
option domain-name "example.com";
option domain-name-servers 8.8.8.8, 8.8.4.4;
default-lease-time 600;
max-lease-time 7200;

# Определение подсети
subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.100 192.168.1.200;
    option routers 192.168.1.1;
    option broadcast-address 192.168.1.255;
}

# Резервирование адреса для конкретного хоста
host hostname {
    hardware ethernet xx:xx:xx:xx:xx:xx;
    fixed-address 192.168.1.50;
}
```

## Схема сети

![alt text](https://github.com/aleti000/mdk02.01/blob/main/pic/network02.jpg)

**Описание сети:**
- **gateway** - шлюз сети (настроен в лабораторной работе №1)
- **CLI-home** - клиентская машина в домашней сети (192.168.0.0/24)
- **SRV1** - сервер в офисной сети (172.16.0.2) - **DHCP-сервер**
- **SRV2** - сервер в офисной сети (172.16.0.3) - **DHCP-клиент**
- **CLI-office** - клиентская машина в офисной сети (172.16.0.0/24) - **DHCP-клиент**

## Методические указания

### Подготовка к выполнению работы

1. **Изучите теоретический материал** о настройке DHCP в Linux
2. **Убедитесь в работоспособности сети** из лабораторной работы №1
3. **Определите параметры DHCP** для подсети office (172.16.0.0/24)
4. **Выберите сервер для установки DHCP** (SRV1 рекомендуется)

### Рекомендации по выполнению

#### При настройке DHCP-сервера:
- Создавайте резервные копии конфигурационных файлов
- Проверяйте синтаксис конфигурации перед перезапуском службы
- Используйте статические резервирования для важных серверов
- Настраивайте разумное время аренды адресов

#### Диагностика DHCP:
- Проверяйте логи службы DHCP
- Используйте утилиты для анализа сетевого трафика
- Тестируйте получение адреса на клиентах

### Возможные проблемы и решения

| Проблема | Возможное решение |
|----------|-------------------|
| DHCP-сервер не запускается | Проверить синтаксис файла dhcpd.conf |
| Клиент не получает адрес | Проверить firewall, маршрут до сервера |
| Конфликт адресов | Проверить уникальность MAC-адресов |
| DHCP не работает после перезагрузки | Проверить автозапуск службы |

## Ход работы

### Часть 1: Установка и настройка DHCP-сервера на SRV1

#### Шаг 1. Установка DHCP-сервера

**На SRV1:**
```bash
# Обновить список пакетов
 apt-get update

# Установить DHCP-сервер
 apt-get install -y isc-dhcp-server

# Установить дополнительные утилиты для диагностики
 apt-get install -y tcpdump net-tools
```

#### Шаг 2. Настройка сетевого интерфейса для DHCP

**На SRV1:**
```bash
# Определить интерфейс для обслуживания DHCP-клиентов
ip addr show

# Отредактировать файл /etc/default/isc-dhcp-server
 tee /etc/default/isc-dhcp-server > /dev/null << 'EOF'
# Интерфейс, на котором будет работать DHCP-сервер
INTERFACESv4="ens21"
INTERFACESv6=""
EOF
```

#### Шаг 3. Создание конфигурации DHCP-сервера

**На SRV1:**
```bash
# Создать резервную копию оригинального файла конфигурации
 cp /etc/dhcp/dhcpd.conf /etc/dhcp/dhcpd.conf.backup

# Создать новую конфигурацию DHCP-сервера
 tee /etc/dhcp/dhcpd.conf > /dev/null << 'EOF'
# Глобальные параметры DHCP-сервера
ddns-update-style none;
option domain-name "office.local";
option domain-name-servers 172.16.0.2, 8.8.8.8;
default-lease-time 3600;
max-lease-time 7200;

# Включаем журналирование
log-facility local7;

# Определение подсети office
subnet 172.16.0.0 netmask 255.255.255.0 {
    # Пул динамических адресов для клиентов
    range 172.16.0.100 172.16.0.200;

    # Параметры сети
    option routers 172.16.0.1;              # Шлюз по умолчанию
    option broadcast-address 172.16.0.255;  # Широковещательный адрес
    option subnet-mask 255.255.255.0;       # Маска подсети

    # DNS-серверы
    option domain-name-servers 172.16.0.2, 8.8.8.8, 8.8.4.4;

    # Дополнительные параметры
    option ntp-servers 172.16.0.2;          # NTP-сервер
    option netbios-name-servers 172.16.0.2; # WINS-сервер
}

# Резервирование статического адреса для SRV2
host srv2 {
    hardware ethernet 52:54:00:12:34:56;   # MAC-адрес SRV2
    fixed-address 172.16.0.3;               # Статический IP-адрес
}

# Резервирование статического адреса для CLI-office
host cli-office {
    hardware ethernet 52:54:00:56:78:90;   # MAC-адрес CLI-office
    fixed-address 172.16.0.4;               # Статический IP-адрес
}
EOF
```

#### Шаг 4. Проверка конфигурации и запуск DHCP-сервера

**На SRV1:**
```bash
# Проверить синтаксис конфигурации
 dhcpd -t

# Если синтаксис корректен, перезапустить службу
 systemctl restart dhcpd

# Включить автозапуск службы
 systemctl enable dhcpd

# Проверить статус службы
 systemctl status dhcpd

# Просмотреть логи DHCP-сервера
 journalctl -xeu dhcpd
```

### Часть 2: Настройка клиентов для получения адресов по DHCP

#### Шаг 5. Настройка SRV2 как DHCP-клиента

**На SRV2:**
```bash
# Настроить интерфейс для получения адреса по DHCP
 tee /etc/net/ifaces/ens21/options > /dev/null << 'EOF'
TYPE=eth
BOOTPROTO=dhcp
EOF

# Удалить статическую конфигурацию IP-адреса
 rm -f /etc/net/ifaces/ens21/ipv4address
 rm -f /etc/net/ifaces/ens21/ipv4route

# Перезапустить сеть
 systemctl restart network

# Проверить полученный адрес
ip addr show ens21
```

#### Шаг 6. Настройка CLI-office как DHCP-клиента

**На CLI-office:**
```bash
# Настроить интерфейс для получения адреса по DHCP через NetworkManager
nmcli connection modify "Wired connection 1" ipv4.method auto

# Перезапустить NetworkManager
 systemctl restart NetworkManager

# Или альтернативно через etcnet
 tee /etc/net/ifaces/eth0/options > /dev/null << 'EOF'
TYPE=eth
BOOTPROTO=dhcp
EOF

# Удалить статическую конфигурацию
 rm -f /etc/net/ifaces/eth0/ipv4address
 systemctl restart network
```

### Часть 3: Тестирование и диагностика DHCP

#### Шаг 7. Проверка работы DHCP-сервера

**На SRV1:**
```bash
# Проверить активные аренды адресов
 cat /var/lib/dhcp/dhcpd.leases

# Просмотреть логи в реальном времени
 tail -f /var/log/syslog | grep dhcpd

# Проверить порт DHCP-сервера
 ss -uln | grep :67

# Тестирование с помощью утилиты dhclient
 dhclient -v ens21
```

#### Шаг 8. Проверка получения адресов клиентами

**На SRV2:**
```bash
# Проверить полученный IP-адрес
ip addr show ens21

# Проверить маршрут по умолчанию
ip route show

# Проверить DNS-серверы
cat /etc/resolv.conf

# Тестирование связи с DHCP-сервером
ping -c 3 172.16.0.2

# Тестирование выхода в интернет
ping -c 3 8.8.8.8
nslookup google.com
```

**На CLI-office:**
```bash
# Проверить полученный IP-адрес
ip addr show

# Проверить маршрут по умолчанию
ip route show

# Проверить DNS-серверы
cat /etc/resolv.conf

# Тестирование связи с другими устройствами сети
ping -c 3 172.16.0.2
ping -c 3 172.16.0.3
```

#### Шаг 9. Диагностика сетевых пакетов DHCP

**На SRV1 (для мониторинга трафика DHCP):**
```bash
# Установить tcpdump для анализа трафика
 apt-get install -y tcpdump

# Начать захват DHCP-пакетов
 tcpdump -i ens21 -n port 67 or port 68 -v

# В другом терминале протестировать получение адреса
# На клиенте:  dhclient -v
```

## Задание

**Настроить DHCP-сервер на SRV1 для обслуживания подсети office:**

1. **SRV1** - DHCP-сервер с адресом 172.16.0.2/24
2. **SRV2** - получает статический адрес 172.16.0.3/24 через DHCP (резервирование по MAC)
3. **CLI-office** - получает динамический адрес из пула 172.16.0.100-172.16.0.200
4. **Дополнительные параметры** - настроить DNS-серверы, NTP-сервер, доменное имя

**Критерии выполнения работы:**
Работа считается выполненной если:
- DHCP-сервер на SRV1 работает и обслуживает клиентов
- SRV2 получает адрес 172.16.0.3/24 через DHCP
- CLI-office получает динамический адрес из заданного пула
- Клиенты могут пинговать интернет-адреса и разрешать доменные имена

## Критерии выполнения работы

Работа считается выполненной если:

1. **DHCP-сервер настроен** на SRV1 и работает корректно
2. **Статическое резервирование** работает для SRV2 (адрес 172.16.0.3)
3. **Динамические адреса** выдаются CLI-office из заданного пула
4. **Сетевые параметры** корректно распределяются клиентам (шлюз, DNS)
5. **Клиенты сети** могут взаимодействовать друг с другом и выходить в интернет

## Возможные проблемы и решения

| Проблема | Возможное решение |
|----------|-------------------|
| DHCP-сервер не запускается | Проверить синтаксис dhcpd.conf: `dhcpd -t` |
| Клиент не получает адрес | Проверить firewall: ` iptables -L` |
| Конфликт статических адресов | Убедиться в уникальности MAC-адресов |
| Не работает после перезагрузки | Проверить автозапуск: `systemctl enable isc-dhcp-server` |
| Пакеты не доходят до сервера | Проверить маршрут: `ip route show` |

## Полезные команды для диагностики

```bash
# Проверка статуса DHCP-сервера
 systemctl status isc-dhcp-server

# Проверка синтаксиса конфигурации
 dhcpd -t

# Просмотр активных аренд
 cat /var/lib/dhcp/dhcpd.leases

# Просмотр логов DHCP
 tail -f /var/log/syslog | grep dhcpd

# Тестирование получения адреса
 dhclient -v -r &&  dhclient -v

# Проверка сетевых интерфейсов
ip addr show

# Проверка маршрутизации
ip route show

# Проверка DNS
nslookup google.com

# Мониторинг DHCP-трафика
 tcpdump -i eth0 -n port 67 or port 68
